<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mnémosyne - Résultats</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet"href="{{ url_for('static', filename='css/cohorte.css') }}">

    <!-- D3.js pour le diagramme de Sankey -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    
    <!-- Chart.js pour les graphiques modernes -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

</head>
<body>

    <header>
        <a href="{{ url_for('index.index') }}" class="logo-link" title="Retour à l'accueil">
            <img src="{{ url_for('static', filename='img/logo_univ.png') }}" alt="Université Sorbonne Paris Nord" class="logo-univ">
        </a>
        
        <a href="{{ url_for('admin.admin_dashboard') }}" class="logo-link" title="Admin">
            <img src="{{ url_for('static', filename='img/logo_admin.png') }}" alt="Logo admin" class="logo-admin">
        </a>
    </header>

    <div class="container">

        <a href="{{ url_for('index.index') }}" class="nav-link">
            <i class="bi bi-arrow-left"></i> Faire une nouvelle recherche
        </a>

        <h2 class="section-title">Détails de la Cohorte</h2>

        <div class="criteria-box">
            <div class="criteria-text">
                Département : <strong>{{ sel_dept }}</strong> &nbsp;|&nbsp; 
                Année : <strong>{{ sel_year }}</strong> &nbsp;|&nbsp; 
                Rythme : <strong>{{ sel_rythme }}</strong>
            </div>
            {% if unique_count %}
                <span class="count-badge">{{ unique_count }} Étudiants</span>
            {% endif %}
        </div>

        <!-- Diagramme de Sankey -->
        <div class="sankey-container">
            <div id="sankey-chart"></div>
            <div class="sankey-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #3498db;"></div>
                    <span>Entrée</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #A8A8A8;"></div>
                    <span>Années BUT</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #9b59b6;"></div>
                    <span>Entrée directe BUT2</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #f39c12;"></div>
                    <span>Redoublement (sortant)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #e67e22;"></div>
                    <span>Redoublant entrant</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #e74c3c;"></div>
                    <span>Abandon</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #E91E63;"></div>
                    <span>Réorientation</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #27ae60;"></div>
                    <span>Diplômés</span>
                </div>
            </div>
        </div>

        <h2 class="section-title">Indicateurs de Performance</h2>

        <div class="kpi-row">
            <div class="chart-card">
                <h4>Origine Entrée BUT 1</h4>
                <div class="kpi-container-inner" style="position:relative;">
                    <canvas id="chartOrigine"></canvas>
                    <div class="kpi-value" id="valOrigine" style="top:65%;">--</div>
                </div>
                <div style="display:flex; gap:20px; margin-top:8px; font-size:12px;">
                    <span><span style="display:inline-block;width:12px;height:12px;background:#3498db;border-radius:2px;margin-right:5px;"></span>Nouveaux: <strong id="lblNouveaux">0</strong></span>
                    <span><span style="display:inline-block;width:12px;height:12px;background:#e67e22;border-radius:2px;margin-right:5px;"></span>Redoublants: <strong id="lblRedoublants">0</strong></span>
                </div>
            </div>
            <div class="chart-card" id="cardGaugeBUT1">
                <h4>Passage BUT 1 <i class="bi bi-arrow-right"></i> BUT 2</h4>
                <div class="kpi-container-inner">
                    <canvas id="gaugeBUT1"></canvas>
                    <div class="kpi-value" id="valBUT1">--%</div>
                </div>
            </div>
            <div class="chart-card" id="cardGaugeBUT2">
                <h4>Passage BUT 2 <i class="bi bi-arrow-right"></i> BUT 3</h4>
                <div class="kpi-container-inner">   
                    <canvas id="gaugeBUT2"></canvas>
                    <div class="kpi-value" id="valBUT2">--%</div>
                </div>
            </div>
        </div>

        <div class="kpi-row">
            <div class="chart-card">
                <h4>Taux de Diplomation Global <i class="bi bi-mortarboard"></i></h4>
                <div class="kpi-container-inner">
                    <canvas id="gaugeOverall"></canvas>
                    <div class="kpi-value" id="valOverall">--%</div>
                </div>
            </div>
            <div class="chart-card" style="grid-column: span 2;">
                <h4>Bilan Global de la Cohorte (Chart.js)</h4>
                <div class="chart-container-inner" style="height: 300px;">
                    <canvas id="chartBilanGlobal"></canvas>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="chart-card">
                <h4>Nuage des Abandons</h4>
                <div class="chart-container-inner"><canvas id="chartAbandons"></canvas></div>
            </div>
            <div class="chart-card">
                <h4>Comparaison Rythme FI/FA <i class="bi bi-bar-chart"></i></h4>
                <div class="chart-container-inner" style="height: 300px; position: relative;">
                    <canvas id="chartFIFAComparisonNew"></canvas>
                </div>
            </div>
        </div>

    </div>

    <script>
        console.log('=== Script starting ===');
        console.log('Stats:', {{ sankey_stats|tojson|safe }});
        console.log('Unique count:', {{ unique_count or 0 }});
        console.log('FI count:', {{ fi_unique_count or 0 }});
        console.log('FA count:', {{ fa_unique_count or 0 }});
        
        // Données du diagramme de Sankey - calculées depuis les vraies données
        {% if sankey_stats %}
        const stats = {
            but1_total: {{ sankey_stats.but1_total or 0 }},
            but1_admis: {{ sankey_stats.but1_admis or 0 }},
            but1_redouble: {{ sankey_stats.but1_redouble or 0 }},
            but1_abandon: {{ sankey_stats.but1_abandon or 0 }},
            but2_total: {{ sankey_stats.but2_total or 0 }},
            but2_admis: {{ sankey_stats.but2_admis or 0 }},
            but2_redouble: {{ sankey_stats.but2_redouble or 0 }},
            but2_abandon: {{ sankey_stats.but2_abandon or 0 }},
            but2_reorientation: {{ sankey_stats.but2_reorientation or 0 }},
            but3_total: {{ sankey_stats.but3_total or 0 }},
            but3_diplome: {{ sankey_stats.but3_diplome or 0 }},
            but3_redouble: {{ sankey_stats.but3_redouble or 0 }},
            but3_abandon: {{ sankey_stats.but3_abandon or 0 }},
            nouveaux_but2: {{ sankey_stats.nouveaux_but2 or 0 }},
            redoublants_entrant_but1: {{ sankey_stats.redoublants_entrant_but1 or 0 }},
            redoublants_entrant_but2: {{ sankey_stats.redoublants_entrant_but2 or 0 }},
            redoublants_entrant_but3: {{ sankey_stats.redoublants_entrant_but3 or 0 }}
        };
        {% else %}
        const stats = {
            but1_total: 0, but1_admis: 0, but1_redouble: 0, but1_abandon: 0,
            but2_total: 0, but2_admis: 0, but2_redouble: 0, but2_abandon: 0, but2_reorientation: 0,
            but3_total: 0, but3_diplome: 0, but3_redouble: 0, but3_abandon: 0,
            nouveaux_but2: 0,
            redoublants_entrant_but1: 0, redoublants_entrant_but2: 0, redoublants_entrant_but3: 0
        };
        {% endif %}

        // Paramètres actuels de l'URL pour la navigation
        const currentYear = {{ selected_year or 2021 }};
        const currentDept = "{{ selected_dept or '' }}";
        const currentRythme = "{{ selected_rythme or 'TOUS' }}";

        // Construire les données Sankey à partir des statistiques réelles
        // Avec colonnes fixes pour un alignement précis
        function buildSankeyData(stats) {
            const nodes = [];
            const links = [];
            let nodeId = 0;

            // Helper pour ajouter un nœud avec colonne fixe
            function addNode(name, column) {
                const id = nodeId++;
                nodes.push({ name, id, column });
                return id;
            }

            // Colonnes: 0=Entrée, 1=BUT1, 2=BUT2, 3=BUT3, 4=Sortie
            // Créer les nœuds avec leurs colonnes fixes
            const entreeId = addNode("Entrée", 0);
            const but1Id = addNode("BUT1", 1);
            const but2Id = addNode("BUT2", 2);
            const but3Id = addNode("BUT3", 3);
            const diplomeId = addNode("Diplômés", 4);
            
            // Nœuds secondaires (redoublements, abandons) - alignés avec le BUT suivant
            const redoubleBut1Id = addNode("Redoublement BUT1", 2);
            const abandonBut1Id = addNode("Abandon BUT1", 2);
            const entreeBut2Id = addNode("Entrée directe BUT2", 1);
            
            const redoubleBut2Id = addNode("Redoublement BUT2", 3);
            const abandonBut2Id = addNode("Abandon BUT2", 3);
            const reorientationId = addNode("Réorientation", 3);
            
            const redoubleBut3Id = addNode("Redoublement BUT3", 4);
            const abandonBut3Id = addNode("Abandon BUT3", 4);

            // Nœuds pour les redoublants entrants (venant de l'année précédente)
            const redoublantEntrantBut1Id = addNode("Redoublant entrant BUT1", 0);
            const redoublantEntrantBut2Id = addNode("Redoublant entrant BUT2", 1);
            const redoublantEntrantBut3Id = addNode("Redoublant entrant BUT3", 2);

            // Créer les liens avec les vraies valeurs
            if (stats.but1_total > 0) {
                links.push({ source: entreeId, target: but1Id, value: stats.but1_total, order: 0 });
            }

            // Redoublants entrants (venant de l'année précédente)
            if (stats.redoublants_entrant_but1 > 0) {
                links.push({ source: redoublantEntrantBut1Id, target: but1Id, value: stats.redoublants_entrant_but1, order: 1 });
            }
            if (stats.redoublants_entrant_but2 > 0) {
                links.push({ source: redoublantEntrantBut2Id, target: but2Id, value: stats.redoublants_entrant_but2, order: 1 });
            }
            if (stats.redoublants_entrant_but3 > 0) {
                links.push({ source: redoublantEntrantBut3Id, target: but3Id, value: stats.redoublants_entrant_but3, order: 1 });
            }

            // BUT1 vers destinations (ordre important: BUT2 en premier pour être en haut)
            if (stats.but1_admis > 0) {
                links.push({ source: but1Id, target: but2Id, value: stats.but1_admis, order: 0 });
            }
            if (stats.but1_redouble > 0) {
                links.push({ source: but1Id, target: redoubleBut1Id, value: stats.but1_redouble, order: 1 });
            }
            if (stats.but1_abandon > 0) {
                links.push({ source: but1Id, target: abandonBut1Id, value: stats.but1_abandon, order: 2 });
            }

            // Entrées directes BUT2
            if (stats.nouveaux_but2 > 0) {
                links.push({ source: entreeBut2Id, target: but2Id, value: stats.nouveaux_but2, order: 0 });
            }

            // BUT2 vers destinations (ordre: BUT3 en premier)
            if (stats.but2_admis > 0) {
                links.push({ source: but2Id, target: but3Id, value: stats.but2_admis, order: 0 });
            }
            if (stats.but2_redouble > 0) {
                links.push({ source: but2Id, target: redoubleBut2Id, value: stats.but2_redouble, order: 1 });
            }
            if (stats.but2_abandon > 0) {
                links.push({ source: but2Id, target: abandonBut2Id, value: stats.but2_abandon, order: 2 });
            }
            if (stats.but2_reorientation > 0) {
                links.push({ source: but2Id, target: reorientationId, value: stats.but2_reorientation, order: 3 });
            }

            // BUT3 vers destinations (ordre: Diplômés en premier)
            if (stats.but3_diplome > 0) {
                links.push({ source: but3Id, target: diplomeId, value: stats.but3_diplome, order: 0 });
            }
            if (stats.but3_redouble > 0) {
                links.push({ source: but3Id, target: redoubleBut3Id, value: stats.but3_redouble, order: 1 });
            }
            if (stats.but3_abandon > 0) {
                links.push({ source: but3Id, target: abandonBut3Id, value: stats.but3_abandon, order: 2 });
            }

            // Trier les liens par ordre pour éviter les croisements
            links.sort((a, b) => a.order - b.order);

            // Filtrer les nœuds qui n'ont pas de liens
            const usedNodeIds = new Set();
            links.forEach(l => {
                usedNodeIds.add(l.source);
                usedNodeIds.add(l.target);
            });

            const filteredNodes = nodes.filter(n => usedNodeIds.has(n.id));
            
            // Renuméroter les IDs
            const idMap = {};
            filteredNodes.forEach((n, i) => {
                idMap[n.id] = i;
                n.id = i;
            });

            links.forEach(l => {
                l.source = idMap[l.source];
                l.target = idMap[l.target];
            });

            return { nodes: filteredNodes, links };
        }

        const sankeyData = buildSankeyData(stats);

        // Couleurs par type de nœud
        const nodeColors = {
            "Entrée": "#3498db",              // Bleu - neutre, entrée
            "BUT1": "#A8A8A8",                // Gris - niveau neutre
            "BUT2": "#A8A8A8",                // Gris - niveau neutre
            "BUT3": "#A8A8A8",                // Gris - niveau neutre
            "Entrée directe BUT2": "#9b59b6", // Violet - entrée spéciale (passerelle)
            "Redoublement BUT1": "#f39c12",   // Orange - attention, redoublement
            "Redoublement BUT2": "#f39c12",   // Orange - attention
            "Redoublement BUT3": "#f39c12",   // Orange - attention
            "Redoublant entrant BUT1": "#e67e22", // Orange foncé - redoublant qui revient
            "Redoublant entrant BUT2": "#e67e22", // Orange foncé
            "Redoublant entrant BUT3": "#e67e22", // Orange foncé
            "Abandon BUT1": "#e74c3c",        // Rouge - négatif, abandon
            "Abandon BUT2": "#e74c3c",        // Rouge - négatif
            "Abandon BUT3": "#e74c3c",        // Rouge - négatif
            "Réorientation": "#e91e63",       // Rose - départ du cursus
            "Diplômés": "#27ae60"             // Vert - positif, succès!
        };

        // Création du diagramme de Sankey avec positionnement personnalisé
        function createSankeyDiagram() {
            const container = document.getElementById('sankey-chart');
            const margin = { top: 15, right: 130, bottom: 30, left: 80 };
            const width = container.clientWidth - margin.left - margin.right;
            const height = 350 - margin.top - margin.bottom;

            // Nettoyer le conteneur
            d3.select("#sankey-chart").selectAll("*").remove();

            if (sankeyData.nodes.length === 0) {
                d3.select("#sankey-chart")
                    .append("p")
                    .style("text-align", "center")
                    .style("color", "#777")
                    .style("padding", "50px")
                    .text("Pas assez de données pour afficher le diagramme de flux.");
                return;
            }

            // Création du SVG
            const svg = d3.select("#sankey-chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Configuration du générateur Sankey
            const sankey = d3.sankey()
                .nodeId(d => d.id)
                .nodeWidth(12)
                .nodePadding(30)
                .nodeSort((a, b) => {
                    // Trier pour que BUT soit en haut, puis les autres en dessous
                    const priority = {
                        "Entrée": 0,
                        "BUT1": 0,
                        "BUT2": 0,
                        "BUT3": 0,
                        "Diplômés": 0,
                        "Entrée directe BUT2": 1,
                        "Redoublement BUT1": 2,
                        "Redoublement BUT2": 2,
                        "Redoublement BUT3": 2,
                        "Abandon BUT1": 3,
                        "Abandon BUT2": 3,
                        "Abandon BUT3": 3,
                        "Réorientation": 4
                    };
                    return (priority[a.name] || 5) - (priority[b.name] || 5);
                })
                .linkSort((a, b) => {
                    // Trier les liens pour que le flux principal soit en haut
                    return (a.order || 0) - (b.order || 0);
                })
                .nodeAlign(d3.sankeyLeft)
                .extent([[0, 0], [width, height]]);

            // Génération du layout
            let { nodes, links } = sankey({
                nodes: sankeyData.nodes.map(d => Object.assign({}, d)),
                links: sankeyData.links.map(d => Object.assign({}, d))
            });

            // Repositionner manuellement les nœuds
            const columnWidth = width / 5;
            const columnPositions = {
                0: 0,
                1: columnWidth,
                2: columnWidth * 2,
                2.5: columnWidth * 2.7,
                3: columnWidth * 3.5,
                4: width - 20
            };

            const topY = 5;
            const secondaryY = 200; // Position Y fixe pour les nœuds secondaires
            const mainNodeNames = ["Entrée", "BUT1", "BUT2", "BUT3", "Diplômés"];
            // --- NOUVEAU CODE : POSITIONNEMENT DYNAMIQUE ET HAUTEUR AUTO ---

            // 1. On regroupe les nœuds par colonne
            const nodesByColumn = {};
            nodes.forEach(node => {
                const originalNode = sankeyData.nodes.find(n => n.name === node.name);
                const col = originalNode ? originalNode.column : 0;
                if (!nodesByColumn[col]) nodesByColumn[col] = [];
                nodesByColumn[col].push(node);
            });

            // 2. Ordre de priorité (Haut vers Bas)
            const verticalPriority = {
                "Entrée": 1, "BUT1": 1, "BUT2": 1, "BUT3": 1, "Diplômés": 1,
                "Entrée directe BUT2": 2,
                "Redoublant entrant BUT1": 2, "Redoublant entrant BUT2": 2, "Redoublant entrant BUT3": 2,
                "Redoublement BUT1": 3, "Redoublement BUT2": 3, "Redoublement BUT3": 3,
                "Réorientation": 4,
                "Abandon BUT1": 5, "Abandon BUT2": 5, "Abandon BUT3": 5
            };

            // Variable pour mémoriser le point le plus bas du graphique
            let maxGraphHeight = 0;

            // 3. Positionnement dynamique
            Object.keys(nodesByColumn).forEach(col => {
                const colNodes = nodesByColumn[col];
                
                // Tri par priorité
                colNodes.sort((a, b) => {
                    const pA = verticalPriority[a.name] || 10;
                    const pB = verticalPriority[b.name] || 10;
                    return pA - pB;
                });

                // Position X
                const xPos = (columnPositions[col] !== undefined) ? columnPositions[col] : col * (width/5);
                
                // Position Y (Empilement)
                let currentY = 5; 
                
                colNodes.forEach(node => {
                    const nodeHeight = Math.max(node.y1 - node.y0, 25);
                    
                    node.x0 = xPos;
                    node.x1 = xPos + 12;
                    node.y0 = currentY;
                    node.y1 = currentY + nodeHeight;
                    
                    // On met à jour la hauteur maximale atteinte pour agrandir le cadre ensuite
                    if (node.y1 > maxGraphHeight) {
                        maxGraphHeight = node.y1;
                    }

                    // Espace entre les nœuds (60px pour éviter que ça se touche)
                    currentY += nodeHeight + 60; 
                });
            });

            // --- ETAPE CRITIQUE : REDIMENSIONNER LE SVG ---
            // On agrandit le cadre pour tout faire rentrer sans couper
            const newTotalHeight = maxGraphHeight + margin.top + margin.bottom + 50;
            
            d3.select("#sankey-chart svg")
                .attr("height", newTotalHeight);

            // Recalculer les liens après repositionnement
            sankey.update({ nodes, links });

            // Créer les gradients pour les liens
            const defs = svg.append("defs");
            links.forEach((link, i) => {
                const gradient = defs.append("linearGradient")
                    .attr("id", `gradient-${i}`)
                    .attr("gradientUnits", "userSpaceOnUse")
                    .attr("x1", link.source.x1)
                    .attr("x2", link.target.x0);
                
                gradient.append("stop")
                    .attr("offset", "0%")
                    .attr("stop-color", nodeColors[link.source.name] || "#888");
                
                gradient.append("stop")
                    .attr("offset", "100%")
                    .attr("stop-color", nodeColors[link.target.name] || "#888");
            });

            // Dessin des liens Sankey avec courbes
            const link = svg.append("g")
                .attr("fill", "none")
                .selectAll("path")
                .data(links)
                .enter()
                .append("path")
                .attr("class", "sankey-link")
                .attr("d", d3.sankeyLinkHorizontal())
                .attr("stroke", (d, i) => `url(#gradient-${i})`)
                .attr("stroke-width", d => Math.max(1, d.width))
                .on("mouseover", function(event, d) {
                    d3.select(this).style("stroke-opacity", 0.8);
                    tooltip.style("opacity", 1)
                        .html(`<strong>${d.source.name} → ${d.target.name}</strong><br/>${d.value} étudiants`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).style("stroke-opacity", 0.5);
                    tooltip.style("opacity", 0);
                });

            // Créer un tooltip
            const tooltip = d3.select("body").append("div")
                .attr("class", "sankey-tooltip")
                .style("position", "absolute")
                .style("background", "rgba(0,0,0,0.8)")
                .style("color", "#fff")
                .style("padding", "8px 12px")
                .style("border-radius", "4px")
                .style("font-size", "12px")
                .style("pointer-events", "none")
                .style("opacity", 0)
                .style("z-index", 1000);

            // Dessin des nœuds
            const node = svg.append("g")
                .selectAll("g")
                .data(nodes)
                .enter()
                .append("g")
                .attr("class", "sankey-node")
                .call(d3.drag()
                    .on("start", function(event, d) {
                        d3.select(this).classed("dragging", true);
                    })
                    .on("drag", function(event, d) {
                        // Déplacer le nœud
                        const dy = event.dy;
                        const dx = event.dx;
                        const nodeHeight = d.y1 - d.y0;
                        const nodeWidth = d.x1 - d.x0;
                        
                        // Mettre à jour les positions Y
                        d.y0 = Math.max(0, Math.min(height - nodeHeight, d.y0 + dy));
                        d.y1 = d.y0 + nodeHeight;
                        
                        // Mettre à jour les positions X
                        d.x0 = Math.max(0, Math.min(width - nodeWidth, d.x0 + dx));
                        d.x1 = d.x0 + nodeWidth;
                        
                        // Mettre à jour le rectangle
                        d3.select(this).select("rect")
                            .attr("x", d.x0)
                            .attr("y", d.y0);
                        
                        // Mettre à jour les labels
                        d3.select(this).selectAll("text")
                            .filter((_, i) => i === 0) // Label nom
                            .attr("x", d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                            .attr("y", (d.y1 + d.y0) / 2);
                        
                        d3.select(this).selectAll("text")
                            .filter((_, i) => i === 1) // Label valeur
                            .attr("x", (d.x0 + d.x1) / 2)
                            .attr("y", (d.y0 + d.y1) / 2);
                        
                        // Mettre à jour tous les liens connectés
                        sankey.update({ nodes, links });
                        
                        // Redessiner les liens
                        link.attr("d", d3.sankeyLinkHorizontal());
                        
                        // Mettre à jour les gradients
                        links.forEach((l, i) => {
                            svg.select(`#gradient-${i}`)
                                .attr("x1", l.source.x1)
                                .attr("x2", l.target.x0);
                        });
                    })
                    .on("end", function(event, d) {
                        d3.select(this).classed("dragging", false);
                    })
                );

            // Rectangles des nœuds avec coins arrondis
            node.append("rect")
                .attr("x", d => d.x0)
                .attr("y", d => d.y0)
                .attr("height", d => Math.max(d.y1 - d.y0, 20))
                .attr("width", d => d.x1 - d.x0)
                .attr("rx", 3)
                .attr("ry", 3)
                .attr("fill", d => nodeColors[d.name] || "#888")
                .attr("stroke", d => d3.color(nodeColors[d.name] || "#888").darker(0.5))
                .attr("stroke-width", 1)
                .style("cursor", d => (d.name.includes("Redoublement") || d.name.includes("Redoublant entrant")) ? "pointer" : "grab")
                .on("click", function(event, d) {
                    // Si c'est un nœud de redoublement sortant, naviguer vers l'année suivante
                    if (d.name.includes("Redoublement") && !d.name.includes("entrant")) {
                        const nextYear = currentYear + 1;
                        const url = `/cohorte?year=${nextYear}&dept=${encodeURIComponent(currentDept)}&rythme=${encodeURIComponent(currentRythme)}`;
                        window.location.href = url;
                    }
                    // Si c'est un redoublant entrant, naviguer vers l'année précédente
                    if (d.name.includes("Redoublant entrant")) {
                        const prevYear = currentYear - 1;
                        const url = `/cohorte?year=${prevYear}&dept=${encodeURIComponent(currentDept)}&rythme=${encodeURIComponent(currentRythme)}`;
                        window.location.href = url;
                    }
                })
                .on("mouseover", function(event, d) {
                    const incoming = links.filter(l => l.target.id === d.id).reduce((sum, l) => sum + l.value, 0);
                    const outgoing = links.filter(l => l.source.id === d.id).reduce((sum, l) => sum + l.value, 0);
                    let tooltipText = `<strong>${d.name}</strong><br/>${Math.max(incoming, outgoing)} étudiants`;
                    if (d.name.includes("Redoublement") && !d.name.includes("entrant")) {
                        tooltipText += `<br/><em>Cliquer pour voir ${currentYear + 1}</em>`;
                    }
                    if (d.name.includes("Redoublant entrant")) {
                        tooltipText += `<br/><em>Cliquer pour voir ${currentYear - 1}</em>`;
                    }
                    tooltip.style("opacity", 1)
                        .html(tooltipText)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                });

            // Labels des nœuds (nom)
            node.append("text")
                .attr("x", d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                .attr("y", d => (d.y1 + d.y0) / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", d => d.x0 < width / 2 ? "start" : "end")
                .text(d => d.name)
                .style("font-size", "11px")
                .style("font-weight", "600")
                .style("fill", "#333")
                .style("text-shadow", "1px 1px 0 #fff, -1px -1px 0 #fff");

            // Labels des nœuds (valeur au centre)
            node.append("text")
                .attr("x", d => (d.x0 + d.x1) / 2)
                .attr("y", d => (d.y0 + d.y1) / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", "middle")
                .text(d => {
                    const incoming = links.filter(l => l.target.id === d.id).reduce((sum, l) => sum + l.value, 0);
                    const outgoing = links.filter(l => l.source.id === d.id).reduce((sum, l) => sum + l.value, 0);
                    return Math.max(incoming, outgoing) || "";
                })
                .style("font-size", "10px")
                .style("fill", "#fff")
                .style("font-weight", "bold");

            // Info-bulle pour les nœuds
            node.select("rect").append("title")
                .text(d => {
                    const incoming = links.filter(l => l.target.id === d.id).reduce((sum, l) => sum + l.value, 0);
                    const outgoing = links.filter(l => l.source.id === d.id).reduce((sum, l) => sum + l.value, 0);
                    return `${d.name}\n${Math.max(incoming, outgoing)} étudiants`;
                });
        }

        // Initialisation et redimensionnement
        document.addEventListener('DOMContentLoaded', createSankeyDiagram);
        window.addEventListener('resize', () => {
            d3.selectAll('.sankey-tooltip').remove();
            createSankeyDiagram();
        });

        // ============================================
        // GRAPHIQUES CAMEMBERT (PIE CHARTS)
        // ============================================

        // Données pour les camemberts (extraites des résultats)
        // On utilise JavaScript pour compter car les filtres Jinja2 sont limités
        const allResults = [
            {% for row in results %}
            { resultat: "{{ row.resultat }}", rythme: "{{ row.rythme }}" }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        // Initialiser les graphiques Chart.js
        document.addEventListener('DOMContentLoaded', function() {
            
            // ============================================
            // NOUVELLES VISUALISATIONS (CHART.JS)
            // ============================================
            
            // Config globale
            Chart.defaults.font.family = "'Roboto', sans-serif";
            Chart.defaults.color = '#555';
            
            // Fonction Jauge améliorée (cercle complet avec couleur dynamique)
            function createGauge(ctxId, value, total, labelId) {
                const percent = total > 0 ? Math.round((value / total) * 100) : 0;
                if(labelId) document.getElementById(labelId).innerText = percent + "%";
                
                // Couleur dynamique selon le pourcentage
                let mainColor;
                if (percent >= 70) mainColor = '#27ae60';      // Vert - bon
                else if (percent >= 50) mainColor = '#f39c12'; // Orange - moyen
                else mainColor = '#e74c3c';                    // Rouge - faible
                
                new Chart(document.getElementById(ctxId), {
                    type: 'doughnut',
                    data: {
                        labels: ["Réussite", "Autres"],
                        datasets: [{
                            data: [value, Math.max(0, total - value)],
                            backgroundColor: [mainColor, "#e8e8e8"],
                            borderWidth: 0,
                            cutout: '80%'
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { display: false }, 
                            tooltip: { 
                                enabled: true,
                                callbacks: {
                                    label: function(context) {
                                        if (context.label === 'Réussite') {
                                            return value + ' étudiants passés (' + percent + '%)';
                                        } else {
                                            return (total - value) + ' étudiants non passés';
                                        }
                                    }
                                }
                            } 
                        } 
                    }
                });
            }
            
            // 1. ORIGINE - Semi-donut style
            const nbRedoublants = stats.redoublants_entrant_but1 || 0;
            const nbNeo = Math.max(0, (stats.but1_total || 0) - nbRedoublants);
            const pctNouveaux = (stats.but1_total > 0) ? Math.round((nbNeo / stats.but1_total) * 100) : 0;
            
            // Mettre à jour les labels
            document.getElementById('valOrigine').innerText = pctNouveaux + '% Nouveaux';
            document.getElementById('lblNouveaux').innerText = nbNeo;
            document.getElementById('lblRedoublants').innerText = nbRedoublants;
            
            new Chart(document.getElementById('chartOrigine'), {
                type: 'doughnut',
                data: {
                    labels: ["Nouveaux", "Redoublants"],
                    datasets: [{ 
                        data: [nbNeo, nbRedoublants], 
                        backgroundColor: ["#3498db", "#e67e22"],
                        borderWidth: 0,
                        cutout: '75%'
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    rotation: -90,
                    circumference: 180,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a,b) => a+b, 0);
                                    const pct = total > 0 ? Math.round((context.raw / total) * 100) : 0;
                                    return context.label + ': ' + context.raw + ' (' + pct + '%)';
                                }
                            }
                        }
                    } 
                }
            });
            
            // 2. JAUGES - Passage BUT1->BUT2 et BUT2->BUT3
            if (stats.but1_total > 0) {
                createGauge('gaugeBUT1', stats.but1_admis, stats.but1_total, 'valBUT1');
            } else {
                document.getElementById('cardGaugeBUT1').style.display = 'none';
            }
            
            if (stats.but2_total > 0) {
                createGauge('gaugeBUT2', stats.but2_admis, stats.but2_total, 'valBUT2');
            } else {
                document.getElementById('cardGaugeBUT2').style.display = 'none';
            }
            
            // 3. Jauge du taux de diplomation global
            const totalStudents = {{ unique_count or 0 }};
            const totalGraduates = {{ sankey_stats.but3_diplome or 0 }};
            if (totalStudents > 0) {
                createGauge('gaugeOverall', totalGraduates, totalStudents, 'valOverall');
            } else {
                document.getElementById('valOverall').innerText = '0%';
            }
            
            // 4. BILAN GLOBAL (Chart.js) - avec gestion des données incomplètes
            const bilanContainer = document.getElementById('chartBilanGlobal').parentElement;
            
            if (stats.but3_total > 0) {
                // Données complètes - afficher le bilan normal
                const diplomes = stats.but3_diplome || 0;
                const abandons = (stats.but1_abandon || 0) + (stats.but2_abandon || 0) + (stats.but3_abandon || 0);
                const redoublements = (stats.but1_redouble || 0) + (stats.but2_redouble || 0) + (stats.but3_redouble || 0);
                const reorientations = stats.but2_reorientation || 0;
                
                new Chart(document.getElementById('chartBilanGlobal'), {
                    type: 'doughnut',
                    data: {
                        labels: ["Diplômés", "Abandons", "Redoublements", "Réorientations"],
                        datasets: [{
                            data: [diplomes, abandons, redoublements, reorientations],
                            backgroundColor: ["#27ae60", "#e74c3c", "#f39c12", "#E91E63"],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { position: 'right' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a,b) => a+b, 0);
                                        const pct = total > 0 ? Math.round((context.raw / total) * 100) : 0;
                                        return context.label + ': ' + context.raw + ' (' + pct + '%)';
                                    }
                                }
                            }
                        } 
                    }
                });
            } else {
                // Cohorte en cours - afficher un bilan partiel
                const enCours = (stats.but1_admis || 0) + (stats.but2_admis || 0);
                const abandons = (stats.but1_abandon || 0) + (stats.but2_abandon || 0);
                const redoublements = (stats.but1_redouble || 0) + (stats.but2_redouble || 0);
                const reorientations = stats.but2_reorientation || 0;
                
                new Chart(document.getElementById('chartBilanGlobal'), {
                    type: 'doughnut',
                    data: {
                        labels: ["En cours", "Abandons", "Redoublements", "Réorientations"],
                        datasets: [{
                            data: [enCours, abandons, redoublements, reorientations],
                            backgroundColor: ["#3498db", "#e74c3c", "#f39c12", "#E91E63"],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { position: 'right' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a,b) => a+b, 0);
                                        const pct = total > 0 ? Math.round((context.raw / total) * 100) : 0;
                                        return context.label + ': ' + context.raw + ' (' + pct + '%)';
                                    }
                                }
                            }
                        } 
                    }
                });
                
                // Ajouter une note sous le graphique
                const noteDiv = document.createElement('small');
                noteDiv.style.cssText = 'display:block; text-align:center; color:#666; margin-top:8px;';
                noteDiv.innerHTML = '⚠️ Cohorte en cours - diplômés non encore disponibles';
                bilanContainer.appendChild(noteDiv);
            }
            
            // 5. ABANDONS (Bubble) - Utilisation de pourcentages
            const totalAbandons = (stats.but1_abandon || 0) + (stats.but2_abandon || 0) + (stats.but3_abandon || 0);
            const maxRadius = 40;
            const minRadius = 8;
            
            const maxAbandon = Math.max(stats.but1_abandon || 1, stats.but2_abandon || 1, stats.but3_abandon || 1);
            const calcRadius = (val) => {
                if (val === 0) return minRadius;
                return minRadius + ((val / maxAbandon) * (maxRadius - minRadius));
            };
            
            const pct1 = totalAbandons > 0 ? Math.round((stats.but1_abandon / totalAbandons) * 100) : 0;
            const pct2 = totalAbandons > 0 ? Math.round((stats.but2_abandon / totalAbandons) * 100) : 0;
            const pct3 = totalAbandons > 0 ? Math.round((stats.but3_abandon / totalAbandons) * 100) : 0;
            
            new Chart(document.getElementById('chartAbandons'), {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Abandons',
                        data: [
                            { x: 1, y: pct1, r: calcRadius(stats.but1_abandon), raw: stats.but1_abandon },
                            { x: 2, y: pct2, r: calcRadius(stats.but2_abandon), raw: stats.but2_abandon },
                            { x: 3, y: pct3, r: calcRadius(stats.but3_abandon), raw: stats.but3_abandon }
                        ],
                        backgroundColor: ["rgba(52, 152, 219, 0.7)", "rgba(231, 76, 60, 0.7)", "rgba(241, 196, 15, 0.7)"]
                    }]
                },
                options: { 
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const raw = context.raw.raw || 0;
                                    const pct = context.raw.y || 0;
                                    return `${raw} étudiants (${pct}%)`;
                                }
                            }
                        }
                    }, 
                    scales: { 
                        x: { 
                            min: 0, 
                            max: 4, 
                            ticks: { 
                                callback: v => ['','BUT1','BUT2','BUT3',''][v],
                                font: { size: 12 }
                            },
                            grid: { display: false }
                        },
                        y: { 
                            min: 0, 
                            max: 100, 
                            title: { display: true, text: '% des abandons', font: { size: 12 } },
                            ticks: { stepSize: 20 },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        }
                    },
                    responsive: true, 
                    maintainAspectRatio: false
                }
            });
            
            // Graphique FI/FA avec Chart.js (nouveau - dans Indicateurs de Performance)
            const fiCount = {{ fi_unique_count or 0 }};
            const faCount = {{ fa_unique_count or 0 }};
            const fiGrad = {{ fi_diplome_count or 0 }};
            const faGrad = {{ fa_diplome_count or 0 }};
            const fiNonGrad = Math.max(0, fiCount - fiGrad);
            const faNonGrad = Math.max(0, faCount - faGrad);
            
            if (fiCount > 0 || faCount > 0) {
                new Chart(document.getElementById('chartFIFAComparisonNew'), {
                    type: 'bar',
                    data: {
                        labels: ['FI', 'FA'],
                        datasets: [
                            {
                                label: 'Diplômés',
                                data: [fiGrad, faGrad],
                                backgroundColor: ['#5C6BC0', '#5C6BC0'],
                                borderWidth: 0,
                                barThickness: 30
                            },
                            {
                                label: 'Autres étudiants',
                                data: [fiNonGrad, faNonGrad],
                                backgroundColor: ['#EF5350', '#EF5350'],
                                borderWidth: 0,
                                barThickness: 30
                            }
                        ]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0,0,0,0.05)',
                                    drawBorder: false
                                },
                                ticks: {
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            y: {
                                stacked: true,
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        size: 12,
                                        weight: 'bold'
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.raw;
                                    }
                                }
                            },
                            datalabels: {
                                anchor: 'center',
                                align: 'center',
                                color: 'white',
                                font: {
                                    weight: 'bold',
                                    size: 12
                                },
                                formatter: function(value, context) {
                                    return value > 0 ? value : '';
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }
        });
    </script>

</body>
</html>