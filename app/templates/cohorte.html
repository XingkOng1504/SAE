<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mnémosyne - Résultats</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- D3.js pour le diagramme de Sankey -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>

    <style>
        /* --- GLOBAL --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #EBEBEB; /* Gris clair fond */
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
        }

        /* --- HEADER --- */
        header {
            background-color: #1F2A44; /* Bleu nuit */
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* --- CONTENEUR PRINCIPAL --- */
        .container {
            width: 100%;
            max-width: 1100px; /* Un peu plus large pour le tableau */
            margin: 40px auto;
            padding: 0 20px;
            flex: 1;
        }

        /* --- TITRES DE SECTION --- */
        .section-title {
            color: #BCA386; /* Couleur beige/dorée */
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
            margin-top: 30px;
            border-bottom: 2px solid #ccc;
            padding-bottom: 10px;
        }

        /* --- FIL D'ARIANE / NAVIGATION --- */
        .nav-link {
            display: inline-flex;
            align-items: center;
            text-decoration: none;
            color: #555;
            font-size: 0.9rem;
            margin-bottom: 20px;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-link:hover { color: #1F2A44; }
        .nav-link i { margin-right: 5px; }

        /* --- INFO CRITÈRES --- */
        .criteria-box {
            background-color: #fff;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-left: 5px solid #1F2A44;
        }
        .criteria-text { font-size: 1rem; color: #444; }
        .criteria-text strong { color: #1F2A44; }
        .count-badge {
            background-color: #BCA386;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* --- STATISTIQUES (Placeholder layout) --- */
        .stats-row {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            flex: 1;
            background-color: white;
            min-height: 250px;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-style: italic;
            border: 1px solid #eee;
            padding: 20px;
        }

        /* Styles pour le diagramme Sankey */
        .sankey-container {
            width: 100%;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 20px;
        }

        #sankey-chart {
            width: 100%;
            min-height: 450px;
            overflow: visible;
        }

        .sankey-link {
            fill: none;
            stroke-opacity: 0.5;
            transition: stroke-opacity 0.2s;
        }

        .sankey-link:hover {
            stroke-opacity: 0.8;
        }

        .sankey-node rect {
            shape-rendering: crispEdges;
            cursor: grab;
            transition: opacity 0.2s;
        }

        .sankey-node rect:hover {
            opacity: 0.8;
        }

        .sankey-node rect:active {
            cursor: grabbing;
        }

        .sankey-node.dragging rect {
            cursor: grabbing;
            opacity: 0.9;
        }

        .sankey-node text {
            font-family: 'Roboto', sans-serif;
            font-size: 11px;
            fill: #333;
        }

        .sankey-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
            margin-top: 20px;
            justify-content: center;
        }

        /* --- GRAPHIQUES CAMEMBERT --- */
        .charts-row {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .pie-container {
            flex: 1;
            min-width: 350px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 15px;
            overflow: hidden;
        }

        .pie-title {
            font-family: 'Playfair Display', serif;
            font-size: 1rem;
            color: #1F2A44;
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
            white-space: nowrap;
        }

        .pie-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .pie-chart {
            width: 180px;
            height: 180px;
            flex-shrink: 0;
        }

        .pie-legend {
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 8px;
            background-color: transparent;
            border-radius: 4px;
            overflow: hidden;
        }

        .pie-slice {
            transition: opacity 0.2s, transform 0.2s;
            cursor: pointer;
        }

        .pie-slice:hover {
            opacity: 0.8;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
            color: #555;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            flex-shrink: 0;
        }


        .logo-univ { height: 50px; object-fit: contain; }
        .logo-admin { height: 66px; object-fit: contain; }

        .logo-link {
            display: block;
            transition: opacity 0.3s;
        }
        .logo-link:hover {
            opacity: 0.8;
        }

    </style>
</head>
<body>

    <header>
        <a href="{{ url_for('index.index') }}" class="logo-link" title="Retour à l'accueil">
            <img src="{{ url_for('static', filename='img/logo_univ.png') }}" alt="Université Sorbonne Paris Nord" class="logo-univ">
        </a>
        
        <a href="{{ url_for('admin.admin_dashboard') }}" class="logo-link" title="Admin">
            <img src="{{ url_for('static', filename='img/logo_admin.png') }}" alt="Logo admin" class="logo-admin">
        </a>
    </header>

    <div class="container">

        <a href="{{ url_for('index.index') }}" class="nav-link">
            <i class="bi bi-arrow-left"></i> Faire une nouvelle recherche
        </a>

        <h2 class="section-title">Détails de la Cohorte</h2>

        <div class="criteria-box">
            <div class="criteria-text">
                Département : <strong>{{ sel_dept }}</strong> &nbsp;|&nbsp; 
                Année : <strong>{{ sel_year }}</strong> &nbsp;|&nbsp; 
                Rythme : <strong>{{ sel_rythme }}</strong>
            </div>
            {% if results %}
                <span class="count-badge">{{ results|length }} Étudiants</span>
            {% endif %}
        </div>

        <!-- Diagramme de Sankey -->
        <div class="sankey-container">
            <div id="sankey-chart"></div>
            <div class="sankey-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #3498db;"></div>
                    <span>Entrée</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #A8A8A8;"></div>
                    <span>Années BUT</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #9b59b6;"></div>
                    <span>Entrée directe BUT2</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #f39c12;"></div>
                    <span>Redoublement (sortant)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #e67e22;"></div>
                    <span>Redoublant entrant</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #e74c3c;"></div>
                    <span>Abandon</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #E91E63;"></div>
                    <span>Réorientation</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #27ae60;"></div>
                    <span>Diplômés</span>
                </div>
            </div>
        </div>

        <h2 class="section-title">Statistiques</h2>

        <!-- Graphiques Camembert -->
        <div class="charts-row">
            <!-- 1. Camembert: Répartition par résultat -->
            <div class="pie-container">
                <div class="pie-title">1. Répartition par Résultat</div>
                <div class="pie-content">
                    <div id="pie-chart-resultats" class="pie-chart"></div>
                    <div id="pie-legend-resultats" class="pie-legend"></div>
                </div>
            </div>

            <!-- 2. Camembert: Répartition FI / FA -->
            <div class="pie-container">
                <div class="pie-title">2. Répartition par Rythme</div>
                <div class="pie-content">
                    <div id="pie-chart-rythme" class="pie-chart"></div>
                    <div id="pie-legend-rythme" class="pie-legend"></div>
                </div>
            </div>
        </div>

        <div class="charts-row">
            <!-- 3. Camembert: Taux d'admission en BUT2 -->
            <div class="pie-container">
                <div class="pie-title">3. Taux d'admission en BUT2</div>
                <div class="pie-content">
                    <div id="pie-chart-but1" class="pie-chart"></div>
                    <div id="pie-legend-but1" class="pie-legend"></div>
                </div>
            </div>

            <!-- 4. Camembert: Taux d'admission en BUT3 -->
            <div class="pie-container">
                <div class="pie-title">4. Taux d'admission en BUT3</div>
                <div class="pie-content">
                    <div id="pie-chart-but2" class="pie-chart"></div>
                    <div id="pie-legend-but2" class="pie-legend"></div>
                </div>
            </div>
        </div>

        <div class="charts-row">
            <!-- 5. Camembert: Taux de diplomation -->
            <div class="pie-container">
                <div class="pie-title">5. Taux de diplomation</div>
                <div class="pie-content">
                    <div id="pie-chart-but3" class="pie-chart"></div>
                    <div id="pie-legend-but3" class="pie-legend"></div>
                </div>
            </div>

            <!-- 6. Camembert: Répartition des abandons -->
            <div class="pie-container">
                <div class="pie-title">6. Répartition des Abandons par Niveau</div>
                <div class="pie-content">
                    <div id="pie-chart-abandons" class="pie-chart"></div>
                    <div id="pie-legend-abandons" class="pie-legend"></div>
                </div>
            </div>
        </div>

        <div class="charts-row">
            <!-- 7. Camembert: Bilan global cohorte -->
            <div class="pie-container">
                <div class="pie-title">7. Bilan Global de la Cohorte</div>
                <div class="pie-content">
                    <div id="pie-chart-bilan" class="pie-chart"></div>
                    <div id="pie-legend-bilan" class="pie-legend"></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Données du diagramme de Sankey - calculées depuis les vraies données
        {% if sankey_stats %}
        const stats = {
            but1_total: {{ sankey_stats.but1_total or 0 }},
            but1_admis: {{ sankey_stats.but1_admis or 0 }},
            but1_redouble: {{ sankey_stats.but1_redouble or 0 }},
            but1_abandon: {{ sankey_stats.but1_abandon or 0 }},
            but2_total: {{ sankey_stats.but2_total or 0 }},
            but2_admis: {{ sankey_stats.but2_admis or 0 }},
            but2_redouble: {{ sankey_stats.but2_redouble or 0 }},
            but2_abandon: {{ sankey_stats.but2_abandon or 0 }},
            but2_reorientation: {{ sankey_stats.but2_reorientation or 0 }},
            but3_total: {{ sankey_stats.but3_total or 0 }},
            but3_diplome: {{ sankey_stats.but3_diplome or 0 }},
            but3_redouble: {{ sankey_stats.but3_redouble or 0 }},
            but3_abandon: {{ sankey_stats.but3_abandon or 0 }},
            nouveaux_but2: {{ sankey_stats.nouveaux_but2 or 0 }},
            redoublants_entrant_but1: {{ sankey_stats.redoublants_entrant_but1 or 0 }},
            redoublants_entrant_but2: {{ sankey_stats.redoublants_entrant_but2 or 0 }},
            redoublants_entrant_but3: {{ sankey_stats.redoublants_entrant_but3 or 0 }}
        };
        {% else %}
        const stats = {
            but1_total: 0, but1_admis: 0, but1_redouble: 0, but1_abandon: 0,
            but2_total: 0, but2_admis: 0, but2_redouble: 0, but2_abandon: 0, but2_reorientation: 0,
            but3_total: 0, but3_diplome: 0, but3_redouble: 0, but3_abandon: 0,
            nouveaux_but2: 0,
            redoublants_entrant_but1: 0, redoublants_entrant_but2: 0, redoublants_entrant_but3: 0
        };
        {% endif %}

        // Paramètres actuels de l'URL pour la navigation
        const currentYear = {{ selected_year or 2021 }};
        const currentDept = "{{ selected_dept or '' }}";
        const currentRythme = "{{ selected_rythme or 'TOUS' }}";

        // Construire les données Sankey à partir des statistiques réelles
        // Avec colonnes fixes pour un alignement précis
        function buildSankeyData(stats) {
            const nodes = [];
            const links = [];
            let nodeId = 0;

            // Helper pour ajouter un nœud avec colonne fixe
            function addNode(name, column) {
                const id = nodeId++;
                nodes.push({ name, id, column });
                return id;
            }

            // Colonnes: 0=Entrée, 1=BUT1, 2=BUT2, 3=BUT3, 4=Sortie
            // Créer les nœuds avec leurs colonnes fixes
            const entreeId = addNode("Entrée", 0);
            const but1Id = addNode("BUT1", 1);
            const but2Id = addNode("BUT2", 2);
            const but3Id = addNode("BUT3", 3);
            const diplomeId = addNode("Diplômés", 4);
            
            // Nœuds secondaires (redoublements, abandons) - alignés avec le BUT suivant
            const redoubleBut1Id = addNode("Redoublement BUT1", 2);
            const abandonBut1Id = addNode("Abandon BUT1", 2);
            const entreeBut2Id = addNode("Entrée directe BUT2", 1);
            
            const redoubleBut2Id = addNode("Redoublement BUT2", 3);
            const abandonBut2Id = addNode("Abandon BUT2", 3);
            const reorientationId = addNode("Réorientation", 3);
            
            const redoubleBut3Id = addNode("Redoublement BUT3", 4);
            const abandonBut3Id = addNode("Abandon BUT3", 4);

            // Nœuds pour les redoublants entrants (venant de l'année précédente)
            const redoublantEntrantBut1Id = addNode("Redoublant entrant BUT1", 0);
            const redoublantEntrantBut2Id = addNode("Redoublant entrant BUT2", 1);
            const redoublantEntrantBut3Id = addNode("Redoublant entrant BUT3", 2);

            // Créer les liens avec les vraies valeurs
            if (stats.but1_total > 0) {
                links.push({ source: entreeId, target: but1Id, value: stats.but1_total, order: 0 });
            }

            // Redoublants entrants (venant de l'année précédente)
            if (stats.redoublants_entrant_but1 > 0) {
                links.push({ source: redoublantEntrantBut1Id, target: but1Id, value: stats.redoublants_entrant_but1, order: 1 });
            }
            if (stats.redoublants_entrant_but2 > 0) {
                links.push({ source: redoublantEntrantBut2Id, target: but2Id, value: stats.redoublants_entrant_but2, order: 1 });
            }
            if (stats.redoublants_entrant_but3 > 0) {
                links.push({ source: redoublantEntrantBut3Id, target: but3Id, value: stats.redoublants_entrant_but3, order: 1 });
            }

            // BUT1 vers destinations (ordre important: BUT2 en premier pour être en haut)
            if (stats.but1_admis > 0) {
                links.push({ source: but1Id, target: but2Id, value: stats.but1_admis, order: 0 });
            }
            if (stats.but1_redouble > 0) {
                links.push({ source: but1Id, target: redoubleBut1Id, value: stats.but1_redouble, order: 1 });
            }
            if (stats.but1_abandon > 0) {
                links.push({ source: but1Id, target: abandonBut1Id, value: stats.but1_abandon, order: 2 });
            }

            // Entrées directes BUT2
            if (stats.nouveaux_but2 > 0) {
                links.push({ source: entreeBut2Id, target: but2Id, value: stats.nouveaux_but2, order: 0 });
            }

            // BUT2 vers destinations (ordre: BUT3 en premier)
            if (stats.but2_admis > 0) {
                links.push({ source: but2Id, target: but3Id, value: stats.but2_admis, order: 0 });
            }
            if (stats.but2_redouble > 0) {
                links.push({ source: but2Id, target: redoubleBut2Id, value: stats.but2_redouble, order: 1 });
            }
            if (stats.but2_abandon > 0) {
                links.push({ source: but2Id, target: abandonBut2Id, value: stats.but2_abandon, order: 2 });
            }
            if (stats.but2_reorientation > 0) {
                links.push({ source: but2Id, target: reorientationId, value: stats.but2_reorientation, order: 3 });
            }

            // BUT3 vers destinations (ordre: Diplômés en premier)
            if (stats.but3_diplome > 0) {
                links.push({ source: but3Id, target: diplomeId, value: stats.but3_diplome, order: 0 });
            }
            if (stats.but3_redouble > 0) {
                links.push({ source: but3Id, target: redoubleBut3Id, value: stats.but3_redouble, order: 1 });
            }
            if (stats.but3_abandon > 0) {
                links.push({ source: but3Id, target: abandonBut3Id, value: stats.but3_abandon, order: 2 });
            }

            // Trier les liens par ordre pour éviter les croisements
            links.sort((a, b) => a.order - b.order);

            // Filtrer les nœuds qui n'ont pas de liens
            const usedNodeIds = new Set();
            links.forEach(l => {
                usedNodeIds.add(l.source);
                usedNodeIds.add(l.target);
            });

            const filteredNodes = nodes.filter(n => usedNodeIds.has(n.id));
            
            // Renuméroter les IDs
            const idMap = {};
            filteredNodes.forEach((n, i) => {
                idMap[n.id] = i;
                n.id = i;
            });

            links.forEach(l => {
                l.source = idMap[l.source];
                l.target = idMap[l.target];
            });

            return { nodes: filteredNodes, links };
        }

        const sankeyData = buildSankeyData(stats);

        // Couleurs par type de nœud
        const nodeColors = {
            "Entrée": "#3498db",              // Bleu - neutre, entrée
            "BUT1": "#A8A8A8",                // Gris - niveau neutre
            "BUT2": "#A8A8A8",                // Gris - niveau neutre
            "BUT3": "#A8A8A8",                // Gris - niveau neutre
            "Entrée directe BUT2": "#9b59b6", // Violet - entrée spéciale (passerelle)
            "Redoublement BUT1": "#f39c12",   // Orange - attention, redoublement
            "Redoublement BUT2": "#f39c12",   // Orange - attention
            "Redoublement BUT3": "#f39c12",   // Orange - attention
            "Redoublant entrant BUT1": "#e67e22", // Orange foncé - redoublant qui revient
            "Redoublant entrant BUT2": "#e67e22", // Orange foncé
            "Redoublant entrant BUT3": "#e67e22", // Orange foncé
            "Abandon BUT1": "#e74c3c",        // Rouge - négatif, abandon
            "Abandon BUT2": "#e74c3c",        // Rouge - négatif
            "Abandon BUT3": "#e74c3c",        // Rouge - négatif
            "Réorientation": "#e91e63",       // Rose - départ du cursus
            "Diplômés": "#27ae60"             // Vert - positif, succès!
        };

        // Création du diagramme de Sankey avec positionnement personnalisé
        function createSankeyDiagram() {
            const container = document.getElementById('sankey-chart');
            const margin = { top: 15, right: 130, bottom: 30, left: 80 };
            const width = container.clientWidth - margin.left - margin.right;
            const height = 350 - margin.top - margin.bottom;

            // Nettoyer le conteneur
            d3.select("#sankey-chart").selectAll("*").remove();

            if (sankeyData.nodes.length === 0) {
                d3.select("#sankey-chart")
                    .append("p")
                    .style("text-align", "center")
                    .style("color", "#777")
                    .style("padding", "50px")
                    .text("Pas assez de données pour afficher le diagramme de flux.");
                return;
            }

            // Création du SVG
            const svg = d3.select("#sankey-chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Configuration du générateur Sankey
            const sankey = d3.sankey()
                .nodeId(d => d.id)
                .nodeWidth(12)
                .nodePadding(30)
                .nodeSort((a, b) => {
                    // Trier pour que BUT soit en haut, puis les autres en dessous
                    const priority = {
                        "Entrée": 0,
                        "BUT1": 0,
                        "BUT2": 0,
                        "BUT3": 0,
                        "Diplômés": 0,
                        "Entrée directe BUT2": 1,
                        "Redoublement BUT1": 2,
                        "Redoublement BUT2": 2,
                        "Redoublement BUT3": 2,
                        "Abandon BUT1": 3,
                        "Abandon BUT2": 3,
                        "Abandon BUT3": 3,
                        "Réorientation": 4
                    };
                    return (priority[a.name] || 5) - (priority[b.name] || 5);
                })
                .linkSort((a, b) => {
                    // Trier les liens pour que le flux principal soit en haut
                    return (a.order || 0) - (b.order || 0);
                })
                .nodeAlign(d3.sankeyLeft)
                .extent([[0, 0], [width, height]]);

            // Génération du layout
            let { nodes, links } = sankey({
                nodes: sankeyData.nodes.map(d => Object.assign({}, d)),
                links: sankeyData.links.map(d => Object.assign({}, d))
            });

            // Repositionner manuellement les nœuds
            const columnWidth = width / 5;
            const columnPositions = {
                0: 0,
                1: columnWidth,
                2: columnWidth * 2,
                2.5: columnWidth * 2.7,
                3: columnWidth * 3.5,
                4: width - 20
            };

            const topY = 5;
            const secondaryY = 200; // Position Y fixe pour les nœuds secondaires
            const mainNodeNames = ["Entrée", "BUT1", "BUT2", "BUT3", "Diplômés"];
            // --- NOUVEAU CODE : POSITIONNEMENT DYNAMIQUE ET HAUTEUR AUTO ---

            // 1. On regroupe les nœuds par colonne
            const nodesByColumn = {};
            nodes.forEach(node => {
                const originalNode = sankeyData.nodes.find(n => n.name === node.name);
                const col = originalNode ? originalNode.column : 0;
                if (!nodesByColumn[col]) nodesByColumn[col] = [];
                nodesByColumn[col].push(node);
            });

            // 2. Ordre de priorité (Haut vers Bas)
            const verticalPriority = {
                "Entrée": 1, "BUT1": 1, "BUT2": 1, "BUT3": 1, "Diplômés": 1,
                "Entrée directe BUT2": 2,
                "Redoublant entrant BUT1": 2, "Redoublant entrant BUT2": 2, "Redoublant entrant BUT3": 2,
                "Redoublement BUT1": 3, "Redoublement BUT2": 3, "Redoublement BUT3": 3,
                "Réorientation": 4,
                "Abandon BUT1": 5, "Abandon BUT2": 5, "Abandon BUT3": 5
            };

            // Variable pour mémoriser le point le plus bas du graphique
            let maxGraphHeight = 0;

            // 3. Positionnement dynamique
            Object.keys(nodesByColumn).forEach(col => {
                const colNodes = nodesByColumn[col];
                
                // Tri par priorité
                colNodes.sort((a, b) => {
                    const pA = verticalPriority[a.name] || 10;
                    const pB = verticalPriority[b.name] || 10;
                    return pA - pB;
                });

                // Position X
                const xPos = (columnPositions[col] !== undefined) ? columnPositions[col] : col * (width/5);
                
                // Position Y (Empilement)
                let currentY = 5; 
                
                colNodes.forEach(node => {
                    const nodeHeight = Math.max(node.y1 - node.y0, 25);
                    
                    node.x0 = xPos;
                    node.x1 = xPos + 12;
                    node.y0 = currentY;
                    node.y1 = currentY + nodeHeight;
                    
                    // On met à jour la hauteur maximale atteinte pour agrandir le cadre ensuite
                    if (node.y1 > maxGraphHeight) {
                        maxGraphHeight = node.y1;
                    }

                    // Espace entre les nœuds (60px pour éviter que ça se touche)
                    currentY += nodeHeight + 60; 
                });
            });

            // --- ETAPE CRITIQUE : REDIMENSIONNER LE SVG ---
            // On agrandit le cadre pour tout faire rentrer sans couper
            const newTotalHeight = maxGraphHeight + margin.top + margin.bottom + 50;
            
            d3.select("#sankey-chart svg")
                .attr("height", newTotalHeight);

            // Recalculer les liens après repositionnement
            sankey.update({ nodes, links });

            // Créer les gradients pour les liens
            const defs = svg.append("defs");
            links.forEach((link, i) => {
                const gradient = defs.append("linearGradient")
                    .attr("id", `gradient-${i}`)
                    .attr("gradientUnits", "userSpaceOnUse")
                    .attr("x1", link.source.x1)
                    .attr("x2", link.target.x0);
                
                gradient.append("stop")
                    .attr("offset", "0%")
                    .attr("stop-color", nodeColors[link.source.name] || "#888");
                
                gradient.append("stop")
                    .attr("offset", "100%")
                    .attr("stop-color", nodeColors[link.target.name] || "#888");
            });

            // Dessin des liens Sankey avec courbes
            const link = svg.append("g")
                .attr("fill", "none")
                .selectAll("path")
                .data(links)
                .enter()
                .append("path")
                .attr("class", "sankey-link")
                .attr("d", d3.sankeyLinkHorizontal())
                .attr("stroke", (d, i) => `url(#gradient-${i})`)
                .attr("stroke-width", d => Math.max(1, d.width))
                .on("mouseover", function(event, d) {
                    d3.select(this).style("stroke-opacity", 0.8);
                    tooltip.style("opacity", 1)
                        .html(`<strong>${d.source.name} → ${d.target.name}</strong><br/>${d.value} étudiants`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).style("stroke-opacity", 0.5);
                    tooltip.style("opacity", 0);
                });

            // Créer un tooltip
            const tooltip = d3.select("body").append("div")
                .attr("class", "sankey-tooltip")
                .style("position", "absolute")
                .style("background", "rgba(0,0,0,0.8)")
                .style("color", "#fff")
                .style("padding", "8px 12px")
                .style("border-radius", "4px")
                .style("font-size", "12px")
                .style("pointer-events", "none")
                .style("opacity", 0)
                .style("z-index", 1000);

            // Dessin des nœuds
            const node = svg.append("g")
                .selectAll("g")
                .data(nodes)
                .enter()
                .append("g")
                .attr("class", "sankey-node")
                .call(d3.drag()
                    .on("start", function(event, d) {
                        d3.select(this).classed("dragging", true);
                    })
                    .on("drag", function(event, d) {
                        // Déplacer le nœud
                        const dy = event.dy;
                        const dx = event.dx;
                        const nodeHeight = d.y1 - d.y0;
                        const nodeWidth = d.x1 - d.x0;
                        
                        // Mettre à jour les positions Y
                        d.y0 = Math.max(0, Math.min(height - nodeHeight, d.y0 + dy));
                        d.y1 = d.y0 + nodeHeight;
                        
                        // Mettre à jour les positions X
                        d.x0 = Math.max(0, Math.min(width - nodeWidth, d.x0 + dx));
                        d.x1 = d.x0 + nodeWidth;
                        
                        // Mettre à jour le rectangle
                        d3.select(this).select("rect")
                            .attr("x", d.x0)
                            .attr("y", d.y0);
                        
                        // Mettre à jour les labels
                        d3.select(this).selectAll("text")
                            .filter((_, i) => i === 0) // Label nom
                            .attr("x", d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                            .attr("y", (d.y1 + d.y0) / 2);
                        
                        d3.select(this).selectAll("text")
                            .filter((_, i) => i === 1) // Label valeur
                            .attr("x", (d.x0 + d.x1) / 2)
                            .attr("y", (d.y0 + d.y1) / 2);
                        
                        // Mettre à jour tous les liens connectés
                        sankey.update({ nodes, links });
                        
                        // Redessiner les liens
                        link.attr("d", d3.sankeyLinkHorizontal());
                        
                        // Mettre à jour les gradients
                        links.forEach((l, i) => {
                            svg.select(`#gradient-${i}`)
                                .attr("x1", l.source.x1)
                                .attr("x2", l.target.x0);
                        });
                    })
                    .on("end", function(event, d) {
                        d3.select(this).classed("dragging", false);
                    })
                );

            // Rectangles des nœuds avec coins arrondis
            node.append("rect")
                .attr("x", d => d.x0)
                .attr("y", d => d.y0)
                .attr("height", d => Math.max(d.y1 - d.y0, 20))
                .attr("width", d => d.x1 - d.x0)
                .attr("rx", 3)
                .attr("ry", 3)
                .attr("fill", d => nodeColors[d.name] || "#888")
                .attr("stroke", d => d3.color(nodeColors[d.name] || "#888").darker(0.5))
                .attr("stroke-width", 1)
                .style("cursor", d => (d.name.includes("Redoublement") || d.name.includes("Redoublant entrant")) ? "pointer" : "grab")
                .on("click", function(event, d) {
                    // Si c'est un nœud de redoublement sortant, naviguer vers l'année suivante
                    if (d.name.includes("Redoublement") && !d.name.includes("entrant")) {
                        const nextYear = currentYear + 1;
                        const url = `/cohorte?year=${nextYear}&dept=${encodeURIComponent(currentDept)}&rythme=${encodeURIComponent(currentRythme)}`;
                        window.location.href = url;
                    }
                    // Si c'est un redoublant entrant, naviguer vers l'année précédente
                    if (d.name.includes("Redoublant entrant")) {
                        const prevYear = currentYear - 1;
                        const url = `/cohorte?year=${prevYear}&dept=${encodeURIComponent(currentDept)}&rythme=${encodeURIComponent(currentRythme)}`;
                        window.location.href = url;
                    }
                })
                .on("mouseover", function(event, d) {
                    const incoming = links.filter(l => l.target.id === d.id).reduce((sum, l) => sum + l.value, 0);
                    const outgoing = links.filter(l => l.source.id === d.id).reduce((sum, l) => sum + l.value, 0);
                    let tooltipText = `<strong>${d.name}</strong><br/>${Math.max(incoming, outgoing)} étudiants`;
                    if (d.name.includes("Redoublement") && !d.name.includes("entrant")) {
                        tooltipText += `<br/><em>Cliquer pour voir ${currentYear + 1}</em>`;
                    }
                    if (d.name.includes("Redoublant entrant")) {
                        tooltipText += `<br/><em>Cliquer pour voir ${currentYear - 1}</em>`;
                    }
                    tooltip.style("opacity", 1)
                        .html(tooltipText)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                });

            // Labels des nœuds (nom)
            node.append("text")
                .attr("x", d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                .attr("y", d => (d.y1 + d.y0) / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", d => d.x0 < width / 2 ? "start" : "end")
                .text(d => d.name)
                .style("font-size", "11px")
                .style("font-weight", "600")
                .style("fill", "#333")
                .style("text-shadow", "1px 1px 0 #fff, -1px -1px 0 #fff");

            // Labels des nœuds (valeur au centre)
            node.append("text")
                .attr("x", d => (d.x0 + d.x1) / 2)
                .attr("y", d => (d.y0 + d.y1) / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", "middle")
                .text(d => {
                    const incoming = links.filter(l => l.target.id === d.id).reduce((sum, l) => sum + l.value, 0);
                    const outgoing = links.filter(l => l.source.id === d.id).reduce((sum, l) => sum + l.value, 0);
                    return Math.max(incoming, outgoing) || "";
                })
                .style("font-size", "10px")
                .style("fill", "#fff")
                .style("font-weight", "bold");

            // Info-bulle pour les nœuds
            node.select("rect").append("title")
                .text(d => {
                    const incoming = links.filter(l => l.target.id === d.id).reduce((sum, l) => sum + l.value, 0);
                    const outgoing = links.filter(l => l.source.id === d.id).reduce((sum, l) => sum + l.value, 0);
                    return `${d.name}\n${Math.max(incoming, outgoing)} étudiants`;
                });
        }

        // Initialisation et redimensionnement
        document.addEventListener('DOMContentLoaded', createSankeyDiagram);
        window.addEventListener('resize', () => {
            d3.selectAll('.sankey-tooltip').remove();
            createSankeyDiagram();
        });

        // ============================================
        // GRAPHIQUES CAMEMBERT (PIE CHARTS)
        // ============================================

        // Données pour les camemberts (extraites des résultats)
        // On utilise JavaScript pour compter car les filtres Jinja2 sont limités
        const allResults = [
            {% for row in results %}
            { resultat: "{{ row.resultat }}", rythme: "{{ row.rythme }}" }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        // Compter par résultat
        const adm_count = allResults.filter(r => r.resultat && r.resultat.includes('ADM')).length;
        const aj_count = allResults.filter(r => r.resultat && r.resultat.includes('AJ')).length;
        const fail_count = allResults.filter(r => r.resultat && r.resultat.includes('FAIL')).length;
        const autres_count = allResults.length - adm_count - aj_count - fail_count;

        const pieDataResultats = [
            { label: "Admis (ADM)", value: adm_count, color: "#27ae60" },
            { label: "Ajourné (AJ)", value: aj_count, color: "#e74c3c" },
            { label: "Échec (FAIL)", value: fail_count, color: "#c0392b" },
            { label: "Autres", value: autres_count > 0 ? autres_count : 0, color: "#95a5a6" }
        ].filter(d => d.value > 0);

        // Compter par rythme
        const fi_count = allResults.filter(r => r.rythme === 'FI').length;
        const fa_count = allResults.filter(r => r.rythme === 'FA').length;

        const pieDataNiveaux = [
            { label: "Formation Initiale (FI)", value: fi_count, color: "#3498db" },
            { label: "Alternance (FA)", value: fa_count, color: "#e67e22" }
        ].filter(d => d.value > 0);

        // 3. Devenir des étudiants BUT1
        const pieDataBut1 = [
            { label: "Passage en BUT2", value: stats.but1_admis, color: "#27ae60" },
              { label: "Redoublement", value: stats.but1_redouble, color: "#f39c12" },
              { label: "Abandon", value: stats.but1_abandon, color: "#e74c3c" }
        ].filter(d => d.value > 0);

        // 4. Devenir des étudiants BUT2
        const pieDataBut2 = [
            { label: "Passage en BUT3", value: stats.but2_admis, color: "#27ae60" },
              { label: "Redoublement", value: stats.but2_redouble, color: "#f39c12" },
              { label: "Abandon", value: stats.but2_abandon, color: "#e74c3c" },
              { label: "Réorientation", value: stats.but2_reorientation, color: "#e91e63" }
        ].filter(d => d.value > 0);

        // 5. Devenir des étudiants BUT3
        const pieDataBut3 = [
            { label: "Diplômés", value: stats.but3_diplome, color: "#27ae60" },
              { label: "Redoublement", value: stats.but3_redouble, color: "#f39c12" },
              { label: "Abandon", value: stats.but3_abandon, color: "#e74c3c" }
        ].filter(d => d.value > 0);

        // 6. Répartition des abandons par niveau
        const pieDataAbandons = [
            { label: "Abandons BUT1", value: stats.but1_abandon, color: "#3498db" },
              { label: "Abandons BUT2", value: stats.but2_abandon, color: "#e74c3c" },
              { label: "Abandons BUT3", value: stats.but3_abandon, color: "#e74c3c" }
        ].filter(d => d.value > 0);

        // 7. Bilan global de la cohorte
        const totalAbandons = stats.but1_abandon + stats.but2_abandon + stats.but3_abandon;
        const totalRedoublementsSortants = stats.but1_redouble + stats.but2_redouble + stats.but3_redouble;
        const pieDataBilan = [
            { label: "Diplômés", value: stats.but3_diplome, color: "#27ae60" },
              { label: "Abandons", value: totalAbandons, color: "#e74c3c" },
              { label: "Redoublements", value: totalRedoublementsSortants, color: "#f39c12" },
              { label: "Réorientations", value: stats.but2_reorientation, color: "#e91e63" }
        ].filter(d => d.value > 0);

        function createPieChart(containerId, legendId, data) {
            const container = document.getElementById(containerId);
            const legendContainer = document.getElementById(legendId);
            const parentContainer = container ? container.closest('.pie-container') : null;
            
            if (!container) return;

            // Nettoyer le conteneur
            d3.select(`#${containerId}`).selectAll("*").remove();
            d3.select(`#${legendId}`).selectAll("*").remove();

            // Si pas de données, cacher le conteneur parent
            if (data.length === 0) {
                if (parentContainer) {
                    parentContainer.style.display = 'none';
                }
                return;
            }

            // Afficher le conteneur s'il était caché
            if (parentContainer) {
                parentContainer.style.display = 'flex';
                parentContainer.style.flexDirection = 'column';
            }

            const width = 200;
            const height = 200;
            const radius = Math.min(width, height) / 2 - 10;

            const svg = d3.select(`#${containerId}`)
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${width / 2}, ${height / 2})`);

            // Créer le générateur de camembert
            const pie = d3.pie()
                .value(d => d.value)
                .sort(null);

            // Créer le générateur d'arc
            const arc = d3.arc()
                .innerRadius(0)
                .outerRadius(radius);

            // Arc pour l'animation hover
            const arcHover = d3.arc()
                .innerRadius(0)
                .outerRadius(radius + 10);

            // Calculer le total pour les pourcentages
            const total = d3.sum(data, d => d.value);

            // Tooltip
            const tooltip = d3.select("body").append("div")
                .attr("class", "pie-tooltip")
                .style("position", "absolute")
                .style("background", "rgba(0,0,0,0.8)")
                .style("color", "white")
                .style("padding", "8px 12px")
                .style("border-radius", "4px")
                .style("font-size", "12px")
                .style("pointer-events", "none")
                .style("opacity", 0)
                .style("z-index", 1000);

            // Dessiner les tranches
            const slices = svg.selectAll("path")
                .data(pie(data))
                .enter()
                .append("path")
                .attr("class", "pie-slice")
                .attr("d", arc)
                .attr("fill", d => d.data.color)
                .attr("stroke", "white")
                .attr("stroke-width", 2)
                .on("mouseover", function(event, d) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr("d", arcHover);
                    
                    const percentage = ((d.data.value / total) * 100).toFixed(1);
                    tooltip.style("opacity", 1)
                        .html(`<strong>${d.data.label}</strong><br/>${d.data.value} étudiants (${percentage}%)`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr("d", arc);
                    tooltip.style("opacity", 0);
                });

            // Animation d'entrée
            slices.transition()
                .duration(800)
                .attrTween("d", function(d) {
                    const interpolate = d3.interpolate({ startAngle: 0, endAngle: 0 }, d);
                    return function(t) {
                        return arc(interpolate(t));
                    };
                });

            // Labels au centre des tranches
            svg.selectAll("text.pie-label")
                .data(pie(data))
                .enter()
                .append("text")
                .attr("class", "pie-label")
                .attr("transform", d => `translate(${arc.centroid(d)})`)
                .attr("text-anchor", "middle")
                .attr("dy", "0.35em")
                .style("font-size", "11px")
                .style("font-weight", "bold")
                .style("fill", "white")
                .style("text-shadow", "1px 1px 2px rgba(0,0,0,0.5)")
                .style("opacity", 0)
                .text(d => {
                    const percentage = ((d.data.value / total) * 100);
                    const arcAngle = d.endAngle - d.startAngle;
                    // N'afficher que si la tranche est assez grande (> 5% ou angle > 0.3 radian ≈ 17°)
                    if (arcAngle < 0.3 || percentage < 5) return '';
                    return `${percentage.toFixed(0)}%`;
                })
                .transition()
                .delay(800)
                .duration(300)
                .style("opacity", 1);

            // Créer la légende
            const legend = d3.select(`#${legendId}`);
            data.forEach(item => {
                const percentage = ((item.value / total) * 100).toFixed(1);
                legend.append("div")
                    .attr("class", "legend-item")
                    .html(`<div class="legend-color" style="background-color: ${item.color};"></div>
                           <span>${item.label}: ${item.value} (${percentage}%)</span>`);
            });
        }

        // Initialiser les camemberts
        document.addEventListener('DOMContentLoaded', function() {
            createPieChart('pie-chart-resultats', 'pie-legend-resultats', pieDataResultats);
            createPieChart('pie-chart-rythme', 'pie-legend-rythme', pieDataNiveaux);
            createPieChart('pie-chart-but1', 'pie-legend-but1', pieDataBut1);
            createPieChart('pie-chart-but2', 'pie-legend-but2', pieDataBut2);
            createPieChart('pie-chart-but3', 'pie-legend-but3', pieDataBut3);
            createPieChart('pie-chart-abandons', 'pie-legend-abandons', pieDataAbandons);
            createPieChart('pie-chart-bilan', 'pie-legend-bilan', pieDataBilan);
        });

        // Redimensionnement
        window.addEventListener('resize', () => {
            createPieChart('pie-chart-resultats', 'pie-legend-resultats', pieDataResultats);
            createPieChart('pie-chart-rythme', 'pie-legend-rythme', pieDataNiveaux);
            createPieChart('pie-chart-but1', 'pie-legend-but1', pieDataBut1);
            createPieChart('pie-chart-but2', 'pie-legend-but2', pieDataBut2);
            createPieChart('pie-chart-but3', 'pie-legend-but3', pieDataBut3);
            createPieChart('pie-chart-abandons', 'pie-legend-abandons', pieDataAbandons);
            createPieChart('pie-chart-bilan', 'pie-legend-bilan', pieDataBilan);
        });
    </script>

</body>
</html>