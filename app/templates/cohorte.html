<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mnémosyne - Résultats</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- D3.js pour le diagramme de Sankey -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>

    <style>
        /* --- GLOBAL --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #EBEBEB; /* Gris clair fond */
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
        }

        /* --- HEADER --- */
        header {
            background-color: #1F2A44; /* Bleu nuit */
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* --- CONTENEUR PRINCIPAL --- */
        .container {
            width: 100%;
            max-width: 1100px; /* Un peu plus large pour le tableau */
            margin: 40px auto;
            padding: 0 20px;
            flex: 1;
        }

        /* --- TITRES DE SECTION --- */
        .section-title {
            color: #BCA386; /* Couleur beige/dorée */
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
            margin-top: 30px;
            border-bottom: 2px solid #ccc;
            padding-bottom: 10px;
        }

        /* --- FIL D'ARIANE / NAVIGATION --- */
        .nav-link {
            display: inline-flex;
            align-items: center;
            text-decoration: none;
            color: #555;
            font-size: 0.9rem;
            margin-bottom: 20px;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-link:hover { color: #1F2A44; }
        .nav-link i { margin-right: 5px; }

        /* --- INFO CRITÈRES --- */
        .criteria-box {
            background-color: #fff;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-left: 5px solid #1F2A44;
        }
        .criteria-text { font-size: 1rem; color: #444; }
        .criteria-text strong { color: #1F2A44; }
        .count-badge {
            background-color: #BCA386;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* --- TABLEAU --- */
        .table-container {
            background-color: white;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            overflow-x: auto; /* Scroll si trop petit */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        th {
            background-color: #1F2A44;
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-family: 'Playfair Display', serif;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            color: #333;
        }

        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f9f9f9; }

        /* Badges de résultats */
        .status-adm { color: #27ae60; font-weight: bold; }
        .status-fail { color: #c0392b; font-weight: bold; }

        /* --- STATISTIQUES (Placeholder layout) --- */
        .stats-row {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            flex: 1;
            background-color: white;
            min-height: 250px;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-style: italic;
            border: 1px solid #eee;
            padding: 20px;
        }

        /* Styles pour le diagramme Sankey */
        .sankey-container {
            width: 100%;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 20px;
        }

        #sankey-chart {
            width: 100%;
            min-height: 450px;
            overflow: visible;
        }

        .sankey-link {
            fill: none;
            stroke-opacity: 0.5;
            transition: stroke-opacity 0.2s;
        }

        .sankey-link:hover {
            stroke-opacity: 0.8;
        }

        .sankey-node rect {
            shape-rendering: crispEdges;
            cursor: grab;
            transition: opacity 0.2s;
        }

        .sankey-node rect:hover {
            opacity: 0.8;
        }

        .sankey-node rect:active {
            cursor: grabbing;
        }

        .sankey-node.dragging rect {
            cursor: grabbing;
            opacity: 0.9;
        }

        .sankey-node text {
            font-family: 'Roboto', sans-serif;
            font-size: 11px;
            fill: #333;
        }

        .sankey-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
            margin-top: 20px;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            flex-shrink: 0;
        }


        .logo-univ { height: 50px; object-fit: contain; }
        .logo-admin { height: 66px; object-fit: contain; }

        .logo-link {
            display: block;
            transition: opacity 0.3s;
        }
        .logo-link:hover {
            opacity: 0.8;
        }

    </style>
</head>
<body>

    <header>
        <a href="{{ url_for('index.index') }}" class="logo-link" title="Retour à l'accueil">
            <img src="{{ url_for('static', filename='img/logo_univ.png') }}" alt="Université Sorbonne Paris Nord" class="logo-univ">
        </a>
        
        <a href="{{ url_for('admin.admin_dashboard') }}" class="logo-link" title="Admin">
            <img src="{{ url_for('static', filename='img/logo_admin.png') }}" alt="Logo admin" class="logo-admin">
        </a>
    </header>

    <div class="container">

        <a href="{{ url_for('index.index') }}" class="nav-link">
            <i class="bi bi-arrow-left"></i> Faire une nouvelle recherche
        </a>

        <h2 class="section-title">Détails de la Cohorte</h2>

        <div class="criteria-box">
            <div class="criteria-text">
                Département : <strong>{{ sel_dept }}</strong> &nbsp;|&nbsp; 
                Année : <strong>{{ sel_year }}</strong> &nbsp;|&nbsp; 
                Rythme : <strong>{{ sel_rythme }}</strong>
            </div>
            {% if results %}
                <span class="count-badge">{{ results|length }} Étudiants</span>
            {% endif %}
        </div>

        <div class="table-container">
            {% if results %}
            <table>
                <thead>
                    <tr>
                        <th>Département</th>
                        <th>Année Univ</th>
                        <th>Niveau</th>
                        <th>Statut</th> 
                        <th>Résultat</th>
                        <th>INE</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in results %}
                    <tr>
                        <td>{{ row.dept }}</td>
                        <td>{{ row.annee_univ }}</td>
                        <td>BUT {{ row.annee_but }}</td>
                        <td>{{ row.rythme }}</td> 
                        <td>
                            {% if 'ADM' in row['resultat'] %}
                                <span class="status-adm">{{ row['resultat'] }}</span>
                            {% elif 'FAIL' in row['resultat'] or 'AJ' in row['resultat'] %}
                                <span class="status-fail">{{ row['resultat'] }}</span>
                            {% else %}
                                {{ row['resultat'] }}
                            {% endif %}
                        </td>
                        <td>{{ row.ine }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
                <p style="text-align: center; color: #777; padding: 20px;">
                    Aucun étudiant trouvé pour ces critères.
                </p>
            {% endif %}
        </div>

        <h2 class="section-title">Statistiques</h2>
        
        <!-- Diagramme de Sankey -->
        <div class="sankey-container">
            <div id="sankey-chart"></div>
            <div class="sankey-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #E8B4CB;"></div>
                    <span>Entrée</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #A8A8A8;"></div>
                    <span>Années BUT</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #8B4513;"></div>
                    <span>Entrée directe BUT2</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #F4A460;"></div>
                    <span>Redoublement (sortant)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FF8C00;"></div>
                    <span>Redoublant entrant</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4CAF50;"></div>
                    <span>Abandon</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #E91E63;"></div>
                    <span>Réorientation</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #27ae60;"></div>
                    <span>Diplômés</span>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Données du diagramme de Sankey - calculées depuis les vraies données
        {% if sankey_stats %}
        const stats = {
            but1_total: {{ sankey_stats.but1_total or 0 }},
            but1_admis: {{ sankey_stats.but1_admis or 0 }},
            but1_redouble: {{ sankey_stats.but1_redouble or 0 }},
            but1_abandon: {{ sankey_stats.but1_abandon or 0 }},
            but2_total: {{ sankey_stats.but2_total or 0 }},
            but2_admis: {{ sankey_stats.but2_admis or 0 }},
            but2_redouble: {{ sankey_stats.but2_redouble or 0 }},
            but2_abandon: {{ sankey_stats.but2_abandon or 0 }},
            but2_reorientation: {{ sankey_stats.but2_reorientation or 0 }},
            but3_total: {{ sankey_stats.but3_total or 0 }},
            but3_diplome: {{ sankey_stats.but3_diplome or 0 }},
            but3_redouble: {{ sankey_stats.but3_redouble or 0 }},
            but3_abandon: {{ sankey_stats.but3_abandon or 0 }},
            nouveaux_but2: {{ sankey_stats.nouveaux_but2 or 0 }},
            redoublants_entrant_but1: {{ sankey_stats.redoublants_entrant_but1 or 0 }},
            redoublants_entrant_but2: {{ sankey_stats.redoublants_entrant_but2 or 0 }},
            redoublants_entrant_but3: {{ sankey_stats.redoublants_entrant_but3 or 0 }}
        };
        {% else %}
        const stats = {
            but1_total: 0, but1_admis: 0, but1_redouble: 0, but1_abandon: 0,
            but2_total: 0, but2_admis: 0, but2_redouble: 0, but2_abandon: 0, but2_reorientation: 0,
            but3_total: 0, but3_diplome: 0, but3_redouble: 0, but3_abandon: 0,
            nouveaux_but2: 0,
            redoublants_entrant_but1: 0, redoublants_entrant_but2: 0, redoublants_entrant_but3: 0
        };
        {% endif %}

        // Paramètres actuels de l'URL pour la navigation
        const currentYear = {{ selected_year or 2021 }};
        const currentDept = "{{ selected_dept or '' }}";
        const currentRythme = "{{ selected_rythme or 'TOUS' }}";

        // Construire les données Sankey à partir des statistiques réelles
        // Avec colonnes fixes pour un alignement précis
        function buildSankeyData(stats) {
            const nodes = [];
            const links = [];
            let nodeId = 0;

            // Helper pour ajouter un nœud avec colonne fixe
            function addNode(name, column) {
                const id = nodeId++;
                nodes.push({ name, id, column });
                return id;
            }

            // Colonnes: 0=Entrée, 1=BUT1, 2=BUT2, 3=BUT3, 4=Sortie
            // Créer les nœuds avec leurs colonnes fixes
            const entreeId = addNode("Entrée", 0);
            const but1Id = addNode("BUT1", 1);
            const but2Id = addNode("BUT2", 2);
            const but3Id = addNode("BUT3", 3);
            const diplomeId = addNode("Diplômés", 4);
            
            // Nœuds secondaires (redoublements, abandons) - alignés avec le BUT suivant
            const redoubleBut1Id = addNode("Redoublement BUT1", 2);
            const abandonBut1Id = addNode("Abandon BUT1", 2);
            const entreeBut2Id = addNode("Entrée directe BUT2", 1);
            
            const redoubleBut2Id = addNode("Redoublement BUT2", 3);
            const abandonBut2Id = addNode("Abandon BUT2", 3);
            const reorientationId = addNode("Réorientation", 3);
            
            const redoubleBut3Id = addNode("Redoublement BUT3", 4);
            const abandonBut3Id = addNode("Abandon BUT3", 4);

            // Nœuds pour les redoublants entrants (venant de l'année précédente)
            const redoublantEntrantBut1Id = addNode("Redoublant entrant BUT1", 0);
            const redoublantEntrantBut2Id = addNode("Redoublant entrant BUT2", 1);
            const redoublantEntrantBut3Id = addNode("Redoublant entrant BUT3", 2);

            // Créer les liens avec les vraies valeurs
            if (stats.but1_total > 0) {
                links.push({ source: entreeId, target: but1Id, value: stats.but1_total, order: 0 });
            }

            // Redoublants entrants (venant de l'année précédente)
            if (stats.redoublants_entrant_but1 > 0) {
                links.push({ source: redoublantEntrantBut1Id, target: but1Id, value: stats.redoublants_entrant_but1, order: 1 });
            }
            if (stats.redoublants_entrant_but2 > 0) {
                links.push({ source: redoublantEntrantBut2Id, target: but2Id, value: stats.redoublants_entrant_but2, order: 1 });
            }
            if (stats.redoublants_entrant_but3 > 0) {
                links.push({ source: redoublantEntrantBut3Id, target: but3Id, value: stats.redoublants_entrant_but3, order: 1 });
            }

            // BUT1 vers destinations (ordre important: BUT2 en premier pour être en haut)
            if (stats.but1_admis > 0) {
                links.push({ source: but1Id, target: but2Id, value: stats.but1_admis, order: 0 });
            }
            if (stats.but1_redouble > 0) {
                links.push({ source: but1Id, target: redoubleBut1Id, value: stats.but1_redouble, order: 1 });
            }
            if (stats.but1_abandon > 0) {
                links.push({ source: but1Id, target: abandonBut1Id, value: stats.but1_abandon, order: 2 });
            }

            // Entrées directes BUT2
            if (stats.nouveaux_but2 > 0) {
                links.push({ source: entreeBut2Id, target: but2Id, value: stats.nouveaux_but2, order: 0 });
            }

            // BUT2 vers destinations (ordre: BUT3 en premier)
            if (stats.but2_admis > 0) {
                links.push({ source: but2Id, target: but3Id, value: stats.but2_admis, order: 0 });
            }
            if (stats.but2_redouble > 0) {
                links.push({ source: but2Id, target: redoubleBut2Id, value: stats.but2_redouble, order: 1 });
            }
            if (stats.but2_abandon > 0) {
                links.push({ source: but2Id, target: abandonBut2Id, value: stats.but2_abandon, order: 2 });
            }
            if (stats.but2_reorientation > 0) {
                links.push({ source: but2Id, target: reorientationId, value: stats.but2_reorientation, order: 3 });
            }

            // BUT3 vers destinations (ordre: Diplômés en premier)
            if (stats.but3_diplome > 0) {
                links.push({ source: but3Id, target: diplomeId, value: stats.but3_diplome, order: 0 });
            }
            if (stats.but3_redouble > 0) {
                links.push({ source: but3Id, target: redoubleBut3Id, value: stats.but3_redouble, order: 1 });
            }
            if (stats.but3_abandon > 0) {
                links.push({ source: but3Id, target: abandonBut3Id, value: stats.but3_abandon, order: 2 });
            }

            // Trier les liens par ordre pour éviter les croisements
            links.sort((a, b) => a.order - b.order);

            // Filtrer les nœuds qui n'ont pas de liens
            const usedNodeIds = new Set();
            links.forEach(l => {
                usedNodeIds.add(l.source);
                usedNodeIds.add(l.target);
            });

            const filteredNodes = nodes.filter(n => usedNodeIds.has(n.id));
            
            // Renuméroter les IDs
            const idMap = {};
            filteredNodes.forEach((n, i) => {
                idMap[n.id] = i;
                n.id = i;
            });

            links.forEach(l => {
                l.source = idMap[l.source];
                l.target = idMap[l.target];
            });

            return { nodes: filteredNodes, links };
        }

        const sankeyData = buildSankeyData(stats);

        // Couleurs par type de nœud
        const nodeColors = {
            "Entrée": "#E8B4CB",
            "BUT1": "#A8A8A8",
            "BUT2": "#A8A8A8",
            "BUT3": "#A8A8A8",
            "Entrée directe BUT2": "#8B4513",
            "Redoublement BUT1": "#F4A460",
            "Redoublement BUT2": "#F4A460",
            "Redoublement BUT3": "#F4A460",
            "Redoublant entrant BUT1": "#FF8C00",
            "Redoublant entrant BUT2": "#FF8C00",
            "Redoublant entrant BUT3": "#FF8C00",
            "Abandon BUT1": "#4CAF50",
            "Abandon BUT2": "#4CAF50",
            "Abandon BUT3": "#4CAF50",
            "Réorientation": "#E91E63",
            "Diplômés": "#27ae60"
        };

        // Création du diagramme de Sankey avec positionnement personnalisé
        function createSankeyDiagram() {
            const container = document.getElementById('sankey-chart');
            const margin = { top: 15, right: 130, bottom: 30, left: 80 };
            const width = container.clientWidth - margin.left - margin.right;
            const height = 350 - margin.top - margin.bottom;

            // Nettoyer le conteneur
            d3.select("#sankey-chart").selectAll("*").remove();

            if (sankeyData.nodes.length === 0) {
                d3.select("#sankey-chart")
                    .append("p")
                    .style("text-align", "center")
                    .style("color", "#777")
                    .style("padding", "50px")
                    .text("Pas assez de données pour afficher le diagramme de flux.");
                return;
            }

            // Création du SVG
            const svg = d3.select("#sankey-chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Configuration du générateur Sankey
            const sankey = d3.sankey()
                .nodeId(d => d.id)
                .nodeWidth(12)
                .nodePadding(30)
                .nodeSort((a, b) => {
                    // Trier pour que BUT soit en haut, puis les autres en dessous
                    const priority = {
                        "Entrée": 0,
                        "BUT1": 0,
                        "BUT2": 0,
                        "BUT3": 0,
                        "Diplômés": 0,
                        "Entrée directe BUT2": 1,
                        "Redoublement BUT1": 2,
                        "Redoublement BUT2": 2,
                        "Redoublement BUT3": 2,
                        "Abandon BUT1": 3,
                        "Abandon BUT2": 3,
                        "Abandon BUT3": 3,
                        "Réorientation": 4
                    };
                    return (priority[a.name] || 5) - (priority[b.name] || 5);
                })
                .linkSort((a, b) => {
                    // Trier les liens pour que le flux principal soit en haut
                    return (a.order || 0) - (b.order || 0);
                })
                .nodeAlign(d3.sankeyLeft)
                .extent([[0, 0], [width, height]]);

            // Génération du layout
            let { nodes, links } = sankey({
                nodes: sankeyData.nodes.map(d => Object.assign({}, d)),
                links: sankeyData.links.map(d => Object.assign({}, d))
            });

            // Repositionner manuellement les nœuds
            const columnWidth = width / 5;
            const columnPositions = {
                0: 0,
                1: columnWidth,
                2: columnWidth * 2,
                2.5: columnWidth * 2.7,
                3: columnWidth * 3.5,
                4: width - 20
            };

            const topY = 5;
            const secondaryY = 200; // Position Y fixe pour les nœuds secondaires
            const mainNodeNames = ["Entrée", "BUT1", "BUT2", "BUT3", "Diplômés"];
            const secondaryOffsets = {}; // Offset par colonne

            // D'abord positionner les nœuds principaux en haut
            nodes.forEach(node => {
                const originalNode = sankeyData.nodes.find(n => n.name === node.name);
                const col = originalNode?.column;
                const nodeHeight = Math.max(node.y1 - node.y0, 30);
                
                // Position X
                if (col !== undefined && columnPositions[col] !== undefined) {
                    node.x0 = columnPositions[col];
                    node.x1 = columnPositions[col] + 12;
                }

                // Vérifier si c'est un nœud principal (comparaison exacte)
                const isMainNode = mainNodeNames.some(name => node.name === name);

                // Position Y - forcer les nœuds principaux en haut
                if (isMainNode) {
                    // Nœuds principaux TOUJOURS en haut
                    node.y0 = topY;
                    node.y1 = topY + nodeHeight;
                } else {
                    // Position Y différente selon la colonne
                    const colSecondaryY = (col === 3) ? 240 : secondaryY; // Colonne 3 plus bas
                    
                    if (secondaryOffsets[col] === undefined) {
                        secondaryOffsets[col] = colSecondaryY;
                    }
                    node.y0 = secondaryOffsets[col];
                    node.y1 = secondaryOffsets[col] + Math.max(nodeHeight, 25);
                    secondaryOffsets[col] = node.y1 + 25; // Plus d'espacement entre les nœuds
                }
            });

            // Recalculer les liens après repositionnement
            sankey.update({ nodes, links });

            // Créer les gradients pour les liens
            const defs = svg.append("defs");
            links.forEach((link, i) => {
                const gradient = defs.append("linearGradient")
                    .attr("id", `gradient-${i}`)
                    .attr("gradientUnits", "userSpaceOnUse")
                    .attr("x1", link.source.x1)
                    .attr("x2", link.target.x0);
                
                gradient.append("stop")
                    .attr("offset", "0%")
                    .attr("stop-color", nodeColors[link.source.name] || "#888");
                
                gradient.append("stop")
                    .attr("offset", "100%")
                    .attr("stop-color", nodeColors[link.target.name] || "#888");
            });

            // Dessin des liens Sankey avec courbes
            const link = svg.append("g")
                .attr("fill", "none")
                .selectAll("path")
                .data(links)
                .enter()
                .append("path")
                .attr("class", "sankey-link")
                .attr("d", d3.sankeyLinkHorizontal())
                .attr("stroke", (d, i) => `url(#gradient-${i})`)
                .attr("stroke-width", d => Math.max(1, d.width))
                .on("mouseover", function(event, d) {
                    d3.select(this).style("stroke-opacity", 0.8);
                    tooltip.style("opacity", 1)
                        .html(`<strong>${d.source.name} → ${d.target.name}</strong><br/>${d.value} étudiants`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).style("stroke-opacity", 0.5);
                    tooltip.style("opacity", 0);
                });

            // Créer un tooltip
            const tooltip = d3.select("body").append("div")
                .attr("class", "sankey-tooltip")
                .style("position", "absolute")
                .style("background", "rgba(0,0,0,0.8)")
                .style("color", "#fff")
                .style("padding", "8px 12px")
                .style("border-radius", "4px")
                .style("font-size", "12px")
                .style("pointer-events", "none")
                .style("opacity", 0)
                .style("z-index", 1000);

            // Dessin des nœuds
            const node = svg.append("g")
                .selectAll("g")
                .data(nodes)
                .enter()
                .append("g")
                .attr("class", "sankey-node")
                .call(d3.drag()
                    .on("start", function(event, d) {
                        d3.select(this).classed("dragging", true);
                    })
                    .on("drag", function(event, d) {
                        // Déplacer le nœud
                        const dy = event.dy;
                        const dx = event.dx;
                        const nodeHeight = d.y1 - d.y0;
                        const nodeWidth = d.x1 - d.x0;
                        
                        // Mettre à jour les positions Y
                        d.y0 = Math.max(0, Math.min(height - nodeHeight, d.y0 + dy));
                        d.y1 = d.y0 + nodeHeight;
                        
                        // Mettre à jour les positions X
                        d.x0 = Math.max(0, Math.min(width - nodeWidth, d.x0 + dx));
                        d.x1 = d.x0 + nodeWidth;
                        
                        // Mettre à jour le rectangle
                        d3.select(this).select("rect")
                            .attr("x", d.x0)
                            .attr("y", d.y0);
                        
                        // Mettre à jour les labels
                        d3.select(this).selectAll("text")
                            .filter((_, i) => i === 0) // Label nom
                            .attr("x", d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                            .attr("y", (d.y1 + d.y0) / 2);
                        
                        d3.select(this).selectAll("text")
                            .filter((_, i) => i === 1) // Label valeur
                            .attr("x", (d.x0 + d.x1) / 2)
                            .attr("y", (d.y0 + d.y1) / 2);
                        
                        // Mettre à jour tous les liens connectés
                        sankey.update({ nodes, links });
                        
                        // Redessiner les liens
                        link.attr("d", d3.sankeyLinkHorizontal());
                        
                        // Mettre à jour les gradients
                        links.forEach((l, i) => {
                            svg.select(`#gradient-${i}`)
                                .attr("x1", l.source.x1)
                                .attr("x2", l.target.x0);
                        });
                    })
                    .on("end", function(event, d) {
                        d3.select(this).classed("dragging", false);
                    })
                );

            // Rectangles des nœuds avec coins arrondis
            node.append("rect")
                .attr("x", d => d.x0)
                .attr("y", d => d.y0)
                .attr("height", d => Math.max(d.y1 - d.y0, 20))
                .attr("width", d => d.x1 - d.x0)
                .attr("rx", 3)
                .attr("ry", 3)
                .attr("fill", d => nodeColors[d.name] || "#888")
                .attr("stroke", d => d3.color(nodeColors[d.name] || "#888").darker(0.5))
                .attr("stroke-width", 1)
                .style("cursor", d => (d.name.includes("Redoublement") || d.name.includes("Redoublant entrant")) ? "pointer" : "grab")
                .on("click", function(event, d) {
                    // Si c'est un nœud de redoublement sortant, naviguer vers l'année suivante
                    if (d.name.includes("Redoublement") && !d.name.includes("entrant")) {
                        const nextYear = currentYear + 1;
                        const url = `/cohorte?year=${nextYear}&dept=${encodeURIComponent(currentDept)}&rythme=${encodeURIComponent(currentRythme)}`;
                        window.location.href = url;
                    }
                    // Si c'est un redoublant entrant, naviguer vers l'année précédente
                    if (d.name.includes("Redoublant entrant")) {
                        const prevYear = currentYear - 1;
                        const url = `/cohorte?year=${prevYear}&dept=${encodeURIComponent(currentDept)}&rythme=${encodeURIComponent(currentRythme)}`;
                        window.location.href = url;
                    }
                })
                .on("mouseover", function(event, d) {
                    const incoming = links.filter(l => l.target.id === d.id).reduce((sum, l) => sum + l.value, 0);
                    const outgoing = links.filter(l => l.source.id === d.id).reduce((sum, l) => sum + l.value, 0);
                    let tooltipText = `<strong>${d.name}</strong><br/>${Math.max(incoming, outgoing)} étudiants`;
                    if (d.name.includes("Redoublement") && !d.name.includes("entrant")) {
                        tooltipText += `<br/><em>Cliquer pour voir ${currentYear + 1}</em>`;
                    }
                    if (d.name.includes("Redoublant entrant")) {
                        tooltipText += `<br/><em>Cliquer pour voir ${currentYear - 1}</em>`;
                    }
                    tooltip.style("opacity", 1)
                        .html(tooltipText)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                });

            // Labels des nœuds (nom)
            node.append("text")
                .attr("x", d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                .attr("y", d => (d.y1 + d.y0) / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", d => d.x0 < width / 2 ? "start" : "end")
                .text(d => d.name)
                .style("font-size", "11px")
                .style("font-weight", "600")
                .style("fill", "#333")
                .style("text-shadow", "1px 1px 0 #fff, -1px -1px 0 #fff");

            // Labels des nœuds (valeur au centre)
            node.append("text")
                .attr("x", d => (d.x0 + d.x1) / 2)
                .attr("y", d => (d.y0 + d.y1) / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", "middle")
                .text(d => {
                    const incoming = links.filter(l => l.target.id === d.id).reduce((sum, l) => sum + l.value, 0);
                    const outgoing = links.filter(l => l.source.id === d.id).reduce((sum, l) => sum + l.value, 0);
                    return Math.max(incoming, outgoing) || "";
                })
                .style("font-size", "10px")
                .style("fill", "#fff")
                .style("font-weight", "bold");

            // Info-bulle pour les nœuds
            node.select("rect").append("title")
                .text(d => {
                    const incoming = links.filter(l => l.target.id === d.id).reduce((sum, l) => sum + l.value, 0);
                    const outgoing = links.filter(l => l.source.id === d.id).reduce((sum, l) => sum + l.value, 0);
                    return `${d.name}\n${Math.max(incoming, outgoing)} étudiants`;
                });
        }

        // Initialisation et redimensionnement
        document.addEventListener('DOMContentLoaded', createSankeyDiagram);
        window.addEventListener('resize', () => {
            d3.selectAll('.sankey-tooltip').remove();
            createSankeyDiagram();
        });
    </script>

</body>
</html>